--==============================================================================
--                    AEGIS HUB - OBJECTS MODULE
--==============================================================================

local AegisHub = _G.AegisHub
if not AegisHub or not AegisHub.ObjectsPage then 
    warn("Aegis Hub not loaded!") 
    return 
end

local Workspace = game:GetService("Workspace")

local page = AegisHub.ObjectsPage
local Library = AegisHub.Library

-- State
local State = {
    doorsRemoved = false,
    borderWallsRemoved = false,
    
    doorOriginalPositions = {},
    wallOriginalPositions = {},
    
    connections = {}
}

-- Door names from screenshots (exact spellings)
local DOOR_NAMES = {
    "AEDBlastShield",
    "GarageDoor",
    "Gate",
    "Gate2",
    "Gate_GeneratorTerminalComplex",
    "Doors"  -- The Doors folder itself
}

-- Border wall detection - walls in "Divisional" folder
local WALL_FOLDER = "Divisional"

-- Height to move objects (1000 studs)
local MOVE_HEIGHT = 1000

-- Helper function to check if model matches door names
local function isDoorModel(model)
    if not model or not model:IsA("Model") then return false end
    
    for _, doorName in ipairs(DOOR_NAMES) do
        if model.Name:lower():find(doorName:lower()) then
            return true
        end
    end
    
    return false
end

-- Helper function to get all door models
local function getAllDoors()
    local doors = {}
    
    -- Check Doors folder
    local doorsFolder = Workspace:FindFirstChild("Doors")
    if doorsFolder then
        for _, child in ipairs(doorsFolder:GetDescendants()) do
            if child:IsA("Model") and isDoorModel(child) then
                table.insert(doors, child)
            end
        end
    end
    
    -- Check workspace root for door models
    for _, child in ipairs(Workspace:GetChildren()) do
        if child:IsA("Model") and isDoorModel(child) then
            table.insert(doors, child)
        end
    end
    
    return doors
end

-- Helper function to get all border walls
local function getAllBorderWalls()
    local walls = {}
    
    local divisionalFolder = Workspace:FindFirstChild(WALL_FOLDER)
    if divisionalFolder then
        for _, child in ipairs(divisionalFolder:GetDescendants()) do
            if child:IsA("BasePart") or child:IsA("Model") then
                table.insert(walls, child)
            end
        end
    end
    
    return walls
end

-- Helper function to move object up
local function moveObjectUp(obj, originalPosTable)
    if obj:IsA("Model") then
        local primaryPart = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart", true)
        if primaryPart then
            -- Store original CFrame
            if not originalPosTable[obj] then
                originalPosTable[obj] = primaryPart.CFrame
            end
            
            -- Move up MOVE_HEIGHT studs
            local offset = Vector3.new(0, MOVE_HEIGHT, 0)
            obj:SetPrimaryPartCFrame(primaryPart.CFrame + offset)
        end
    elseif obj:IsA("BasePart") then
        -- Store original CFrame
        if not originalPosTable[obj] then
            originalPosTable[obj] = obj.CFrame
        end
        
        -- Move up MOVE_HEIGHT studs
        obj.CFrame = obj.CFrame + Vector3.new(0, MOVE_HEIGHT, 0)
    end
end

-- Helper function to restore object position
local function restoreObjectPosition(obj, originalPosTable)
    local originalCFrame = originalPosTable[obj]
    if not originalCFrame then return end
    
    if obj:IsA("Model") then
        local primaryPart = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart", true)
        if primaryPart then
            obj:SetPrimaryPartCFrame(originalCFrame)
        end
    elseif obj:IsA("BasePart") then
        obj.CFrame = originalCFrame
    end
end

-- Remove All Doors
local function removeDoors()
    local doors = getAllDoors()
    
    for _, door in ipairs(doors) do
        moveObjectUp(door, State.doorOriginalPositions)
    end
    
    print("✓ Removed " .. #doors .. " doors")
end

local function restoreDoors()
    for door, _ in pairs(State.doorOriginalPositions) do
        if door and door.Parent then
            restoreObjectPosition(door, State.doorOriginalPositions)
        end
    end
    
    State.doorOriginalPositions = {}
    print("✓ Restored doors")
end

-- Remove Border Walls
local function removeBorderWalls()
    local walls = getAllBorderWalls()
    
    for _, wall in ipairs(walls) do
        moveObjectUp(wall, State.wallOriginalPositions)
    end
    
    print("✓ Removed " .. #walls .. " border walls")
end

local function restoreBorderWalls()
    for wall, _ in pairs(State.wallOriginalPositions) do
        if wall and wall.Parent then
            restoreObjectPosition(wall, State.wallOriginalPositions)
        end
    end
    
    State.wallOriginalPositions = {}
    print("✓ Restored border walls")
end

-- Create UI
Library:CreateToggle(page, "Remove All Doors", false, function(enabled)
    State.doorsRemoved = enabled
    if enabled then
        removeDoors()
    else
        restoreDoors()
    end
end)

Library:CreateToggle(page, "Remove Border Walls", false, function(enabled)
    State.borderWallsRemoved = enabled
    if enabled then
        removeBorderWalls()
    else
        restoreBorderWalls()
    end
end)

print("✓ Objects Module Loaded")

return true
