--==============================================================================
--                    AEGIS HUB - VISUALS MODULE
--==============================================================================
-- PRESETS - Customize default values here
local PRESETS = {
    XRAY = {
        DEFAULT = 0.5,
        MIN = 0,
        MAX = 1
    },
    INFINITE_ZOOM = 700,  -- Max camera zoom distance
    DOOR_HIGHLIGHT = {
        FILL_COLOR = Color3.fromRGB(255, 50, 50),  -- Red
        OUTLINE_COLOR = Color3.fromRGB(255, 255, 255),  -- White
        FILL_TRANSPARENCY = 0.5,
        OUTLINE_TRANSPARENCY = 0
    }
}

local AegisHub = _G.AegisHub
if not AegisHub or not AegisHub.VisualsPage then 
    warn("Aegis Hub not loaded!") 
    return 
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")

local player = Players.LocalPlayer
local page = AegisHub.VisualsPage
local Library = AegisHub.Library

-- State
local State = {
    fullBrightEnabled = false,
    noFogEnabled = false,
    infZoomEnabled = false,
    allLightingEffectsRemoved = false,
    xrayEnabled = false,
    xrayLevel = PRESETS.XRAY.DEFAULT,
    doorsHighlighted = false,
    
    enforcementConn = nil,
    xrayOriginal = {},
    originalLightingEffects = {},
    doorHighlights = {},
    
    connections = {}
}

-- Full Bright / No Fog Enforcement
local function startEnforcement()
    if State.enforcementConn then State.enforcementConn:Disconnect() end
    
    State.enforcementConn = RunService.Heartbeat:Connect(function()
        if State.fullBrightEnabled then
            Lighting.ClockTime = 12
            Lighting.Brightness = 2
            Lighting.Ambient = Color3.new(1, 1, 1)
            Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
        end
        
        if State.noFogEnabled then
            Lighting.FogStart = 0
            Lighting.FogEnd = 1e10
            local atm = Lighting:FindFirstChildOfClass("Atmosphere")
            if atm then
                atm.Density = 0
                atm.Haze = 0
            end
        end
    end)
    
    table.insert(State.connections, State.enforcementConn)
end

local function stopEnforcement()
    if State.enforcementConn then
        State.enforcementConn:Disconnect()
        State.enforcementConn = nil
    end
end

-- Full Bright
local function enableFullBright()
    Lighting.Brightness = 2
    Lighting.ClockTime = 12
    Lighting.Ambient = Color3.new(1, 1, 1)
    Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
    startEnforcement()
end

local function disableFullBright()
    Lighting.Brightness = 1
    Lighting.ClockTime = 12
    Lighting.Ambient = Color3.fromRGB(127, 127, 127)
    Lighting.OutdoorAmbient = Color3.fromRGB(127, 127, 127)
    
    if not State.noFogEnabled then
        stopEnforcement()
    end
end

-- No Fog
local function enableNoFog()
    Lighting.FogStart = 0
    Lighting.FogEnd = 1e10
    local atm = Lighting:FindFirstChildOfClass("Atmosphere")
    if atm then
        atm.Density = 0
        atm.Haze = 0
    end
    startEnforcement()
end

local function disableNoFog()
    Lighting.FogEnd = 1000
    local atm = Lighting:FindFirstChildOfClass("Atmosphere")
    if atm then
        atm.Density = 0.3
        atm.Haze = 0
    end
    
    if not State.fullBrightEnabled then
        stopEnforcement()
    end
end

-- Infinite Zoom
local function enableInfZoom()
    player.CameraMinZoomDistance = 0.5
    player.CameraMaxZoomDistance = PRESETS.INFINITE_ZOOM
end

local function disableInfZoom()
    player.CameraMinZoomDistance = 0.5
    player.CameraMaxZoomDistance = 128
end

-- Remove All Lighting Effects (Skybox, Bloom, Distortion, etc.)
local function removeAllLightingEffects()
    -- Store and remove all effects from Lighting
    for _, effect in ipairs(Lighting:GetChildren()) do
        if effect:IsA("Sky") or 
           effect:IsA("BloomEffect") or 
           effect:IsA("BlurEffect") or 
           effect:IsA("ColorCorrectionEffect") or 
           effect:IsA("SunRaysEffect") or 
           effect:IsA("DepthOfFieldEffect") or
           effect:IsA("Atmosphere") then
            
            if not State.originalLightingEffects[effect] then
                State.originalLightingEffects[effect] = effect.Parent
            end
            effect.Parent = nil
        end
    end
end

local function restoreAllLightingEffects()
    for effect, parent in pairs(State.originalLightingEffects) do
        if effect then
            effect.Parent = parent
        end
    end
    State.originalLightingEffects = {}
end

-- Door Highlighting System
local DOOR_NAMES = {
    "AEDBlastShield",
    "GarageDoor",
    "Gate",
    "Gate2",
    "Gate_GeneratorTerminalComplex",
}

local function isDoorModel(model)
    if not model or not model:IsA("Model") then return false end
    
    for _, doorName in ipairs(DOOR_NAMES) do
        if model.Name:lower():find(doorName:lower()) then
            return true
        end
    end
    
    return false
end

local function getAllDoors()
    local doors = {}
    
    -- Check Doors folder and ALL descendants
    local doorsFolder = Workspace:FindFirstChild("Doors")
    if doorsFolder then
        -- Get all models in the entire hierarchy
        for _, child in ipairs(doorsFolder:GetDescendants()) do
            if child:IsA("Model") then
                -- Check if model name matches any door name
                local matchesName = false
                for _, doorName in ipairs(DOOR_NAMES) do
                    if child.Name:lower():find(doorName:lower()) then
                        matchesName = true
                        break
                    end
                end
                
                if matchesName then
                    table.insert(doors, child)
                end
            end
        end
    end
    
    -- Also check workspace root for door models
    for _, child in ipairs(Workspace:GetChildren()) do
        if child:IsA("Model") and isDoorModel(child) then
            table.insert(doors, child)
        end
    end
    
    return doors
end

local function clearDoorHighlights()
    for _, highlight in pairs(State.doorHighlights) do
        pcall(function() highlight:Destroy() end)
    end
    State.doorHighlights = {}
end

local function highlightDoors()
    clearDoorHighlights()
    
    local doors = getAllDoors()
    
    for _, door in ipairs(doors) do
        local highlight = Instance.new("Highlight")
        highlight.Adornee = door
        highlight.FillColor = PRESETS.DOOR_HIGHLIGHT.FILL_COLOR
        highlight.OutlineColor = PRESETS.DOOR_HIGHLIGHT.OUTLINE_COLOR
        highlight.FillTransparency = PRESETS.DOOR_HIGHLIGHT.FILL_TRANSPARENCY
        highlight.OutlineTransparency = PRESETS.DOOR_HIGHLIGHT.OUTLINE_TRANSPARENCY
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Parent = door
        
        table.insert(State.doorHighlights, highlight)
    end
    
    print("✓ Highlighted " .. #doors .. " doors")
end

-- X-Ray System
local function applyXray(level)
    for _, inst in ipairs(Workspace:GetDescendants()) do
        if inst:IsA("BasePart") then
            local protected = false
            for _, plr in ipairs(Players:GetPlayers()) do
                if plr.Character and inst:IsDescendantOf(plr.Character) then
                    protected = true
                    break
                end
            end
            
            if not protected then
                if State.xrayOriginal[inst] == nil then
                    State.xrayOriginal[inst] = inst.Transparency
                end
                inst.Transparency = math.max(State.xrayOriginal[inst], level * 0.9)
            end
        end
    end
end

local function restoreXray()
    for part, orig in pairs(State.xrayOriginal) do
        pcall(function()
            if part and part.Parent then
                part.Transparency = orig
            end
        end)
    end
    State.xrayOriginal = {}
end

-- Create UI
Library:CreateToggle(page, "Full Bright", false, function(enabled)
    State.fullBrightEnabled = enabled
    if enabled then enableFullBright() else disableFullBright() end
end)

Library:CreateToggle(page, "No Fog", false, function(enabled)
    State.noFogEnabled = enabled
    if enabled then enableNoFog() else disableNoFog() end
end)

Library:CreateToggle(page, "Infinite Zoom", false, function(enabled)
    State.infZoomEnabled = enabled
    if enabled then enableInfZoom() else disableInfZoom() end
end)

Library:CreateToggle(page, "Remove All Lighting Effects", false, function(enabled)
    State.allLightingEffectsRemoved = enabled
    if enabled then removeAllLightingEffects() else restoreAllLightingEffects() end
end)

Library:CreateToggle(page, "Highlight Doors", false, function(enabled)
    State.doorsHighlighted = enabled
    if enabled then highlightDoors() else clearDoorHighlights() end
end)

-- X-ray with slider
Library:CreateToggleSlider(page, "X-Ray", PRESETS.XRAY.MIN, PRESETS.XRAY.MAX, PRESETS.XRAY.DEFAULT,
    function(enabled)
        State.xrayEnabled = enabled
        if enabled then applyXray(State.xrayLevel) else restoreXray() end
    end,
    function(value)
        State.xrayLevel = math.clamp(tonumber(value) or 0.5, 0, 1)
        if State.xrayEnabled then applyXray(State.xrayLevel) end
    end
)

print("✓ Visuals Module Loaded")

return true
