-- MODULE 2: Resource Mining System (STANDALONE) - FAST VERSION
-- This module handles resource collection from Fedorlite after pickaxe is obtained

local Module2 = {}

-- Services
local Players = game:GetService("Players")

-- Configuration
Module2.Config = {
    FEDORLITE_NAME = "Fedorlite",
    RESOURCE_NAME = "Resource",
    HOLD_DURATION = 0.5,
    RETRY_DELAY = 0.1
}

-- Initialize player references
function Module2:Init()
    self.player = Players.LocalPlayer
    self.character = self.player.Character or self.player.CharacterAdded:Wait()
    self.humanoidRootPart = self.character:WaitForChild("HumanoidRootPart")
    
    -- Handle character respawn
    self.player.CharacterAdded:Connect(function(newCharacter)
        self.character = newCharacter
        self.humanoidRootPart = newCharacter:WaitForChild("HumanoidRootPart")
    end)
    
    print("[Module 2] Initialized - Resource Mining System (FAST)")
end

-- Check if player has both required items
function Module2:HasRequiredItems()
    local backpack = self.player:WaitForChild("Backpack")
    
    local hasRespirator = backpack:FindFirstChild("Civilian Grade Respirator")
    local hasFilter = backpack:FindFirstChild("Filter Replacement")
    
    if hasRespirator and hasFilter then
        print("[Module 2] ✓ Both items detected in backpack!")
        return true
    end
    
    return false
end

-- Check if player has RPK-74M in inventory
function Module2:HasRPK()
    local backpack = self.player:WaitForChild("Backpack")
    
    -- Check backpack
    if backpack:FindFirstChild("RPK-74M") then
        return true
    end
    
    -- Check equipped tools
    for _, item in pairs(self.character:GetChildren()) do
        if item:IsA("Tool") and item.Name == "RPK-74M" then
            return true
        end
    end
    
    return false
end

-- Check if player has pickaxe
function Module2:HasPickaxe()
    local backpack = self.player:WaitForChild("Backpack")
    local characterTools = self.character:GetChildren()
    
    if backpack:FindFirstChild("Pickaxe") then
        return true
    end
    
    for _, item in pairs(characterTools) do
        if item:IsA("Tool") and item.Name == "Pickaxe" then
            return true
        end
    end
    
    return false
end

-- Equip the pickaxe
function Module2:EquipPickaxe()
    local backpack = self.player:WaitForChild("Backpack")
    local pickaxe = backpack:FindFirstChild("Pickaxe")
    
    if pickaxe then
        self.character.Humanoid:EquipTool(pickaxe)
        return true
    end
    
    for _, item in pairs(self.character:GetChildren()) do
        if item:IsA("Tool") and item.Name == "Pickaxe" then
            return true
        end
    end
    
    return false
end

-- Find all Fedorlite models in workspace
function Module2:FindFedorliteModels()
    local fedorlites = {}
    local workspace = game:GetService("Workspace")
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj.Name == self.Config.FEDORLITE_NAME then
            table.insert(fedorlites, obj)
        end
    end
    
    return fedorlites
end

-- Find Resource objects within a Fedorlite model
function Module2:FindResourcesInFedorlite(fedorliteModel)
    local resources = {}
    
    for _, obj in pairs(fedorliteModel:GetDescendants()) do
        if obj.Name == self.Config.RESOURCE_NAME then
            table.insert(resources, obj)
        end
    end
    
    return resources
end

-- Mine a single resource
function Module2:MineResource(resourceObject)
    local resourcePart = resourceObject:IsA("BasePart") and resourceObject or resourceObject:FindFirstChildWhichIsA("BasePart", true)
    
    if not resourcePart or resourcePart.Transparency >= 1 then
        return false
    end
    
    -- Find ProximityPrompt
    local proximityPrompt = nil
    local proximityAttachment = resourceObject:FindFirstChild("ProximityAttachment", true)
    
    if proximityAttachment then
        proximityPrompt = proximityAttachment:FindFirstChildOfClass("ProximityPrompt")
    end
    
    if not proximityPrompt then
        proximityPrompt = resourceObject:FindFirstChildOfClass("ProximityPrompt", true)
    end
    
    if not proximityPrompt then
        return false
    end
    
    -- Teleport to resource
    local resourcePosition = resourcePart.Position
    local targetPosition = resourcePosition + Vector3.new(0, 2, 0)
    self.humanoidRootPart.CFrame = CFrame.new(targetPosition)
    
    -- Monitor transparency
    local mined = false
    local connection = resourcePart:GetPropertyChangedSignal("Transparency"):Connect(function()
        if resourcePart.Transparency >= 1 then
            mined = true
        end
    end)
    
    -- Position update loop
    local keepInPlace = true
    task.spawn(function()
        while keepInPlace do
            self.humanoidRootPart.CFrame = CFrame.new(resourcePart.Position + Vector3.new(0, 2, 0))
            wait(0.001)
        end
    end)
    
    -- Mine
    local attempts = 0
    while not mined and attempts < 20 do
        attempts = attempts + 1
        fireproximityprompt(proximityPrompt, self.Config.HOLD_DURATION)
        
        wait(self.Config.HOLD_DURATION + 0.1)
        
        if resourcePart.Transparency >= 1 then
            mined = true
            break
        end
        
        if not proximityPrompt or not proximityPrompt.Parent then
            mined = true
            break
        end
        
        wait(self.Config.RETRY_DELAY)
    end
    
    keepInPlace = false
    connection:Disconnect()
    
    return mined
end

-- Mine exactly 1 resource then return
function Module2:MineOneResource()
    local fedorlites = self:FindFedorliteModels()
    
    if #fedorlites == 0 then
        return false
    end
    
    for _, fedorlite in ipairs(fedorlites) do
        local resources = self:FindResourcesInFedorlite(fedorlite)
        
        if #resources > 0 then
            -- Update character reference
            self.character = self.player.Character or self.player.CharacterAdded:Wait()
            self.humanoidRootPart = self.character:WaitForChild("HumanoidRootPart")
            
            -- Mine first resource
            local success = self:MineResource(resources[1])
            
            if success then
                print("[Module 2] ✓ Mined 1 resource!")
                return true
            end
        end
    end
    
    return false
end

-- Main execution loop
function Module2:Run()
    print("[Module 2] ========================================")
    print("[Module 2] STARTING MODULE 2 (FAST)")
    print("[Module 2] ========================================")
    
    -- Wait for pickaxe
    while not self:HasPickaxe() do
        print("[Module 2] Waiting for pickaxe...")
        task.wait()
    end
    
    print("[Module 2] ✓ Pickaxe detected!")
    self:EquipPickaxe()
    task.wait()
    
    -- Mine FIRST resource
    print("[Module 2] ========================================")
    print("[Module 2] Mining FIRST resource...")
    print("[Module 2] ========================================")
    local minedSuccessfully = false
    
    while not minedSuccessfully do
        self.character = self.player.Character or self.player.CharacterAdded:Wait()
        self.humanoidRootPart = self.character:WaitForChild("HumanoidRootPart")
        self:EquipPickaxe()
        
        minedSuccessfully = self:MineOneResource()
        
        if not minedSuccessfully then
            print("[Module 2] Mining failed, retrying...")
            task.wait()
        end
    end
    
    print("[Module 2] ✓ First resource mined!")
    
    -- Teleport to first sell location
    print("[Module 2] ========================================")
    print("[Module 2] FIRST SELL")
    print("[Module 2] ========================================")
    print("[Module 2] Teleporting to sell: -251 13 -814")
    self.humanoidRootPart.CFrame = CFrame.new(-251, 13, -814)
    
    print("[Module 2] Waiting 2 seconds at sell location...")
    wait(2)
    
    -- Teleport to buy RPK74M and keep trying until acquired
    print("[Module 2] ========================================")
    print("[Module 2] PURCHASING RPK-74M")
    print("[Module 2] ========================================")
    print("[Module 2] Teleporting to: -240 13 -817")
    self.humanoidRootPart.CFrame = CFrame.new(-240, 13, -817)
    
    task.wait()
    
    -- Keep buying until RPK-74M is detected in inventory
    while not self:HasRPK() do
        print("[Module 2] Purchasing RPK-74M...")
        local args = {
            "RPK-74M",
            "LINKON_CS"
        }
        game:GetService("ReplicatedStorage"):WaitForChild("MERCHANT"):WaitForChild("MClientCommunication"):FireServer(unpack(args))
        
        wait(1) -- Wait 1 second between purchase attempts
        
        if self:HasRPK() then
            print("[Module 2] ✓ RPK-74M detected in inventory!")
            break
        else
            print("[Module 2] RPK-74M not detected, retrying purchase...")
        end
    end
    
    -- Mine SECOND resource
    print("[Module 2] ========================================")
    print("[Module 2] Mining SECOND resource...")
    print("[Module 2] ========================================")
    
    minedSuccessfully = false
    
    while not minedSuccessfully do
        self.character = self.player.Character or self.player.CharacterAdded:Wait()
        self.humanoidRootPart = self.character:WaitForChild("HumanoidRootPart")
        self:EquipPickaxe()
        
        minedSuccessfully = self:MineOneResource()
        
        if not minedSuccessfully then
            print("[Module 2] Mining failed, retrying...")
            task.wait()
        end
    end
    
    print("[Module 2] ✓ Second resource mined!")
    
    -- Teleport to sell location again
    print("[Module 2] ========================================")
    print("[Module 2] SECOND SELL")
    print("[Module 2] ========================================")
    print("[Module 2] Teleporting to sell: 312 23 -572")
    self.humanoidRootPart.CFrame = CFrame.new(312, 23, -572)
    
    print("[Module 2] Waiting 2 seconds at sell location...")
    wait(2)
    
    -- Teleport to buy respirator and filter
    print("[Module 2] ========================================")
    print("[Module 2] PURCHASING RESPIRATOR & FILTER")
    print("[Module 2] ========================================")
    print("[Module 2] Teleporting to buy: -240 13 -839")
    self.humanoidRootPart.CFrame = CFrame.new(-240, 13, -839)
    wait(0.5)
    
    -- Keep buying until both items are detected in inventory
    while not self:HasRequiredItems() do
        print("[Module 2] [1/2] Purchasing Civilian Grade Respirator...")
        local args1 = {
            "Civilian Grade Respirator",
            "BARTON_EC"
        }
        game:GetService("ReplicatedStorage"):WaitForChild("MERCHANT"):WaitForChild("MClientCommunication"):FireServer(unpack(args1))
        
        wait(0.5)
        
        print("[Module 2] [2/2] Purchasing Filter Replacement...")
        local args2 = {
            "Filter Replacement",
            "BARTON_EC"
        }
        game:GetService("ReplicatedStorage"):WaitForChild("MERCHANT"):WaitForChild("MClientCommunication"):FireServer(unpack(args2))
        
        wait(1) -- Wait 1 second before checking
        
        if self:HasRequiredItems() then
            print("[Module 2] ✓ Both items detected in inventory!")
            break
        else
            print("[Module 2] Items not detected, retrying purchase...")
        end
    end
    
    print("[Module 2] ========================================")
    print("[Module 2] ✓✓✓ BOTH ITEMS ACQUIRED! ✓✓✓")
    print("[Module 2] ========================================")
    
    -- Teleport to final location
    print("[Module 2] Teleporting to final location: -125 5 -790")
    self.humanoidRootPart.CFrame = CFrame.new(-125, 5, -790)
    
    print("[Module 2] ========================================")
    print("[Module 2] LOADING NEXT SCRIPT...")
    print("[Module 2] ========================================")
    
    -- Load Module 3
    loadstring(game:HttpGet("https://raw.githubusercontent.com/gamedev1164/hhkalskjdfg/refs/heads/main/Reactor/Module%203", true))()
    
    print("[Module 2] ========================================")
    print("[Module 2] NEXT SCRIPT LOADED - MODULE 2 STOPPING")
    print("[Module 2] ========================================")
end

-- STANDALONE EXECUTION
print("========================================")
print("MODULE 2: Resource Mining (FAST)")
print("========================================")

Module2:Init()
Module2:Run()

print("========================================")
print("MODULE 2: COMPLETE")
print("========================================")
