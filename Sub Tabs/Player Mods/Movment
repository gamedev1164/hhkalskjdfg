--==============================================================================
--                    AEGIS HUB - MOVEMENT MODULE (FIXED)
--==============================================================================

local AegisHub = _G.AegisHub
if not AegisHub or not AegisHub.MovementPage then 
    warn("Aegis Hub not loaded!") 
    return 
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local page = AegisHub.MovementPage
local Library = AegisHub.Library  -- FIX: Get Library from AegisHub

-- State
local State = {
    speedEnabled = false,
    speedValue = 50,
    origWalkSpeed = nil,
    
    jumpEnabled = false,
    jumpValue = 50,
    origJumpHeight = nil,
    origJumpPower = nil,
    
    infJumpEnabled = false,
    
    cframeFlyEnabled = false,
    cframeFlySpeed = 100,
    cframeFlyConn = nil,
    cframeFlyKeys = {W = false, A = false, S = false, D = false, Q = false, E = false, Shift = false},
    
    godModeEnabled = false,
    godModeConn = nil,
    
    connections = {}
}

-- Helper functions
local function getChar() return player.Character end
local function getHumanoid() local c = getChar() return c and c:FindFirstChildOfClass("Humanoid") end
local function getHRP() local c = getChar() return c and c:FindFirstChild("HumanoidRootPart") end

-- Instant Movement Physics
local function applyInstantMovement(hum)
    if not hum then return end
    pcall(function()
        local char = hum.Parent
        if char then
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                hrp.CustomPhysicalProperties = PhysicalProperties.new(0.7, 0, 0, 100, 0)
            end
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                    pcall(function()
                        part.CustomPhysicalProperties = PhysicalProperties.new(0.7, 0, 0, 100, 0)
                    end)
                end
            end
        end
    end)
end

local function removeInstantMovement(hum)
    if not hum then return end
    pcall(function()
        local char = hum.Parent
        if char then
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    pcall(function()
                        part.CustomPhysicalProperties = PhysicalProperties.new(0.7, 0.3, 0.5, 1, 1)
                    end)
                end
            end
        end
    end)
end

-- Speed
local function enableSpeed()
    local hum = getHumanoid()
    if hum then
        if not State.origWalkSpeed then 
            State.origWalkSpeed = hum.WalkSpeed 
        end
        hum.WalkSpeed = State.speedValue
        applyInstantMovement(hum)
    end
end

local function disableSpeed()
    local hum = getHumanoid()
    if hum then
        hum.WalkSpeed = State.origWalkSpeed or 16
        removeInstantMovement(hum)
    end
end

-- Jump
local function enableJump()
    local hum = getHumanoid()
    if hum then
        if hum.UseJumpPower then
            if not State.origJumpPower then 
                State.origJumpPower = hum.JumpPower 
            end
            hum.JumpPower = State.jumpValue
        else
            if not State.origJumpHeight then 
                State.origJumpHeight = hum.JumpHeight 
            end
            hum.JumpHeight = State.jumpValue
        end
    end
end

local function disableJump()
    local hum = getHumanoid()
    if hum then
        if hum.UseJumpPower then 
            hum.JumpPower = State.origJumpPower or 50
        else 
            hum.JumpHeight = State.origJumpHeight or 7.2 
        end
    end
end

-- Infinite Jump
table.insert(State.connections, UserInputService.JumpRequest:Connect(function()
    if State.infJumpEnabled then
        local hum = getHumanoid()
        if hum then 
            hum:ChangeState(Enum.HumanoidStateType.Jumping) 
        end
    end
end))

-- CFrame Fly
local function setCFrameFlyKey(keyCode, isDown)
    local map = {
        [Enum.KeyCode.W] = "W", [Enum.KeyCode.A] = "A", 
        [Enum.KeyCode.S] = "S", [Enum.KeyCode.D] = "D",
        [Enum.KeyCode.Q] = "Q", [Enum.KeyCode.E] = "E",
        [Enum.KeyCode.LeftShift] = "Shift", [Enum.KeyCode.RightShift] = "Shift"
    }
    if map[keyCode] then 
        State.cframeFlyKeys[map[keyCode]] = isDown 
    end
end

table.insert(State.connections, UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        setCFrameFlyKey(input.KeyCode, true)
    end
end))

table.insert(State.connections, UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        setCFrameFlyKey(input.KeyCode, false)
    end
end))

local function enableCFrameFly()
    local hrp = getHRP()
    if hrp then
        hrp.Anchored = true
    end
    
    State.cframeFlyConn = RunService.RenderStepped:Connect(function(dt)
        if not State.cframeFlyEnabled then return end
        
        local hrp = getHRP()
        if not hrp then return end
        
        hrp.Anchored = true
        
        local cam = Workspace.CurrentCamera
        local look = cam and cam.CFrame.LookVector or hrp.CFrame.LookVector
        local right = cam and cam.CFrame.RightVector or hrp.CFrame.RightVector
        local up = Vector3.new(0, 1, 0)
        local moveDir = Vector3.zero
        
        if State.cframeFlyKeys.W then moveDir = moveDir + look end
        if State.cframeFlyKeys.S then moveDir = moveDir - look end
        if State.cframeFlyKeys.A then moveDir = moveDir - right end
        if State.cframeFlyKeys.D then moveDir = moveDir + right end
        if State.cframeFlyKeys.E then moveDir = moveDir + up end
        if State.cframeFlyKeys.Q then moveDir = moveDir - up end
        
        if moveDir.Magnitude > 0 then
            local speed = State.cframeFlySpeed * (State.cframeFlyKeys.Shift and 2 or 1)
            hrp.CFrame = hrp.CFrame + moveDir.Unit * speed * dt
        end
    end)
    
    table.insert(State.connections, State.cframeFlyConn)
end

local function disableCFrameFly()
    if State.cframeFlyConn then
        State.cframeFlyConn:Disconnect()
        State.cframeFlyConn = nil
    end
    
    local hrp = getHRP()
    if hrp then
        hrp.Anchored = false
    end
end

-- God Mode
local function enableGodMode()
    local hum = getHumanoid()
    if hum then
        hum.MaxHealth = math.huge
        hum.Health = math.huge
    end
    
    State.godModeConn = RunService.Heartbeat:Connect(function()
        if not State.godModeEnabled then return end
        
        local hum = getHumanoid()
        if hum then
            hum.Health = math.huge
        end
    end)
    
    table.insert(State.connections, State.godModeConn)
end

local function disableGodMode()
    if State.godModeConn then
        State.godModeConn:Disconnect()
        State.godModeConn = nil
    end
    
    local hum = getHumanoid()
    if hum then
        hum.MaxHealth = 100
        hum.Health = 100
    end
end

-- Character respawn handler
table.insert(State.connections, player.CharacterAdded:Connect(function()
    task.wait(0.3)
    
    if State.speedEnabled then enableSpeed() end
    if State.jumpEnabled then enableJump() end
    if State.cframeFlyEnabled then 
        disableCFrameFly()
        enableCFrameFly()
    end
    if State.godModeEnabled then enableGodMode() end
end))

-- Create UI
-- Speed with Toggle+Slider
Library:CreateToggleSlider(page, "Speed", 1, 500, 50,
    function(enabled)
        State.speedEnabled = enabled
        if enabled then enableSpeed() else disableSpeed() end
    end,
    function(value)
        State.speedValue = value
        if State.speedEnabled then
            local hum = getHumanoid()
            if hum then hum.WalkSpeed = value end
        end
    end
)

-- Jump Height with Toggle+Slider
Library:CreateToggleSlider(page, "Jump Height", 1, 500, 50,
    function(enabled)
        State.jumpEnabled = enabled
        if enabled then enableJump() else disableJump() end
    end,
    function(value)
        State.jumpValue = value
        if State.jumpEnabled then
            local hum = getHumanoid()
            if hum then
                if hum.UseJumpPower then 
                    hum.JumpPower = value
                else 
                    hum.JumpHeight = value 
                end
            end
        end
    end
)

-- Infinite Jump (toggle only, no slider needed)
Library:CreateToggle(page, "Infinite Jump", false, function(v)
    State.infJumpEnabled = v
end)

-- CFrame Fly with Toggle+Slider
Library:CreateToggleSlider(page, "CFrame Fly", 1, 500, 100,
    function(enabled)
        State.cframeFlyEnabled = enabled
        if enabled then enableCFrameFly() else disableCFrameFly() end
    end,
    function(value)
        State.cframeFlySpeed = value
    end
)

-- God Mode (toggle only, no slider needed)
Library:CreateToggle(page, "God Mode", false, function(v)
    State.godModeEnabled = v
    if v then enableGodMode() else disableGodMode() end
end)

print("âœ“ Movement Module Loaded")

return true
