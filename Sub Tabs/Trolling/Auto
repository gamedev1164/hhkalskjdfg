--==============================================================================
--                    AEGIS HUB - TROLLING AUTO MODULE (CLEAN)
--==============================================================================

local AegisHub = _G.AegisHub
if not AegisHub or not AegisHub.TrollingAuto then 
    warn("Aegis Hub not loaded!") 
    return 
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local page = AegisHub.TrollingAuto
local Library = AegisHub.Library

--==============================================================================
--                          1. OPEN DOORS (HITBOX ARM)
--==============================================================================

local openDoorsState = {
    running = false,
    connection = nil,
    hitboxes = {},
    offset = 0,
    direction = 1
}

local function startOpenDoors()
    if openDoorsState.running then return end
    openDoorsState.running = true
    
    local character = player.Character or player.CharacterAdded:Wait()
    local rightArm = character:WaitForChild("RightHand") or character:WaitForChild("Right Arm")
    local doors = workspace:WaitForChild("Doors")
    
    local doorFolders = {
        "AED", "ARD", "ARD_Offices", "Armoury", "Central/Processing",
        "Coolant", "Divisional", "HR/SC", "Hangar", "Jail",
        "Lab_Wasteland_A", "Processing", "Reactor", "Roof",
        "SpawnedMisc", "Tower/Posts", "Warehouse"
    }
    
    -- Find all hitboxes
    openDoorsState.hitboxes = {}
    for _, folderName in pairs(doorFolders) do
        local folder = doors:FindFirstChild(folderName)
        if folder then
            for _, descendant in pairs(folder:GetDescendants()) do
                if descendant.Name == "Hitbox" and descendant:IsA("BasePart") then
                    table.insert(openDoorsState.hitboxes, descendant)
                end
            end
        end
    end
    
    local speed = 2
    local maxOffset = 2
    
    openDoorsState.connection = RunService.RenderStepped:Connect(function()
        if not rightArm or not openDoorsState.running then return end
        
        openDoorsState.offset = openDoorsState.offset + (openDoorsState.direction * speed)
        
        if openDoorsState.offset >= maxOffset then
            openDoorsState.direction = -1
        elseif openDoorsState.offset <= -maxOffset then
            openDoorsState.direction = 1
        end
        
        local rightArmTip = rightArm.CFrame * CFrame.new(0, -rightArm.Size.Y/2, 0)
        
        for _, hitbox in pairs(openDoorsState.hitboxes) do
            if hitbox and hitbox.Parent then
                hitbox.CFrame = rightArmTip * CFrame.new(0, openDoorsState.offset, 0)
            end
        end
    end)
    
    print("✓ Open Doors started")
end

local function stopOpenDoors()
    openDoorsState.running = false
    if openDoorsState.connection then
        openDoorsState.connection:Disconnect()
        openDoorsState.connection = nil
    end
    print("✓ Open Doors stopped")
end

--==============================================================================
--                          2. AUTO BOOTH PROCESSING
--==============================================================================

local boothState = {
    running = false,
    cachedParts = {},
    lastCacheTime = 0
}

local function getAllProcessingBoothSystems()
    local ROOT = workspace:FindFirstChild("Booths")
    if not ROOT then return {} end
    
    local systems = {}
    for _, obj in ipairs(ROOT:GetDescendants()) do
        if obj.Name == "Processing_BoothSystem" then
            table.insert(systems, obj)
        end
    end
    return systems
end

local function getTouchPartsUnderSystems()
    local currentTime = tick()
    
    if currentTime - boothState.lastCacheTime < 5 and #boothState.cachedParts > 0 then
        return boothState.cachedParts
    end
    
    local parts = {}
    local seen = {}
    
    for _, sys in ipairs(getAllProcessingBoothSystems()) do
        for _, d in ipairs(sys:GetDescendants()) do
            if d:IsA("TouchTransmitter") then
                local part = d.Parent
                if part and part:IsA("BasePart") and not seen[part] then
                    seen[part] = true
                    table.insert(parts, part)
                end
            end
        end
    end
    
    boothState.cachedParts = parts
    boothState.lastCacheTime = currentTime
    
    return parts
end

local function startAutoBoothProcessing()
    if boothState.running then return end
    boothState.running = true
    
    task.spawn(function()
        while boothState.running do
            local character = player.Character
            if character and character.Parent then
                local hrp = character:FindFirstChild("HumanoidRootPart")
                
                if hrp then
                    local parts = getTouchPartsUnderSystems()
                    
                    for _, part in ipairs(parts) do
                        if not boothState.running then break end
                        
                        pcall(function()
                            if part and part.Parent then
                                firetouchinterest(hrp, part, 0)
                                task.wait(0.01)
                                firetouchinterest(hrp, part, 1)
                            end
                        end)
                    end
                end
            end
            
            task.wait(1)
        end
    end)
    
    print("✓ Auto Booth Processing started")
end

local function stopAutoBoothProcessing()
    boothState.running = false
    print("✓ Auto Booth Processing stopped")
end

player.CharacterAdded:Connect(function()
    boothState.cachedParts = {}
    boothState.lastCacheTime = 0
end)

--==============================================================================
--                          3. CLOSE DOORS
--==============================================================================

local closeDoorsState = {
    running = false,
    connection = nil,
    clickDetectors = {},
    timer = 0
}

local function startCloseDoors()
    if closeDoorsState.running then return end
    closeDoorsState.running = true
    
    local doors = workspace:WaitForChild("Doors")
    
    -- Find all ClickDetectors
    closeDoorsState.clickDetectors = {}
    for _, descendant in pairs(doors:GetDescendants()) do
        if descendant:IsA("ClickDetector") then
            table.insert(closeDoorsState.clickDetectors, descendant)
        end
    end
    
    closeDoorsState.timer = 0
    local interval = 0.001
    
    closeDoorsState.connection = RunService.Heartbeat:Connect(function(deltaTime)
        if not closeDoorsState.running then return end
        
        closeDoorsState.timer = closeDoorsState.timer + deltaTime
        
        if closeDoorsState.timer >= interval then
            closeDoorsState.timer = 0
            
            for _, clickDetector in pairs(closeDoorsState.clickDetectors) do
                if clickDetector and clickDetector.Parent then
                    pcall(function()
                        fireclickdetector(clickDetector)
                    end)
                end
            end
        end
    end)
    
    print("✓ Close Doors started (0.001s interval)")
end

local function stopCloseDoors()
    closeDoorsState.running = false
    if closeDoorsState.connection then
        closeDoorsState.connection:Disconnect()
        closeDoorsState.connection = nil
    end
    print("✓ Close Doors stopped")
end

--==============================================================================
--                          4. GET KEYPAD CRACKER (AUTO FARM)
--==============================================================================

local getKeypadCrackerScript = [[
local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local moneyValue = player:WaitForChild("stats"):WaitForChild("Money")

local TARGET_POSITION = Vector3.new(-159, 4, -787)
local scrapGenerators = {}

local function findScrapGenerators()
    local mapElements = workspace:WaitForChild("CoreGameplaySystems")
        :WaitForChild("ScrapSystems")
        :WaitForChild("MapElements")
    
    for _, child in pairs(mapElements:GetChildren()) do
        if string.find(child.Name, "Scrap_Generate") then
            table.insert(scrapGenerators, child)
        end
    end
end

findScrapGenerators()

local currentScrapIndex = 1

local function teleportTo(position)
    if humanoidRootPart then
        humanoidRootPart.CFrame = CFrame.new(position)
    end
end

local function holdEKey(duration)
    local keyCode = Enum.KeyCode.E
    VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
    task.wait(duration)
    VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
end

local function isScrapCollected(scrapGenerate)
    if scrapGenerate:IsA("BasePart") then
        return scrapGenerate.Transparency == 1
    elseif scrapGenerate:FindFirstChildWhichIsA("BasePart", true) then
        local part = scrapGenerate:FindFirstChildWhichIsA("BasePart", true)
        if part then return part.Transparency == 1 end
    end
    return false
end

local function getResourceTransparency(resource)
    if resource:IsA("BasePart") then
        return resource.Transparency
    elseif resource:FindFirstChildWhichIsA("BasePart", true) then
        local part = resource:FindFirstChildWhichIsA("BasePart", true)
        return part.Transparency
    end
    return 1
end

local function countResourcesInBackpack()
    local count = 0
    for _, item in pairs(player.Backpack:GetChildren()) do
        if item.Name == "Resource" then
            count = count + 1
        end
    end
    return count
end

task.spawn(function()
    while true do
        task.wait(0.05)
        
        if moneyValue.Value < 25 then
            if currentScrapIndex > #scrapGenerators then
                currentScrapIndex = 1
                task.wait(1)
            end
            
            local scrapGenerate = scrapGenerators[currentScrapIndex]
            
            if isScrapCollected(scrapGenerate) then
                currentScrapIndex = currentScrapIndex + 1
                task.wait(0.05)
                continue
            end
            
            teleportTo(scrapGenerate.Position)
            task.wait(0.05)
            
            if scrapGenerate:FindFirstChildOfClass("ProximityPrompt") then
                local prompt = scrapGenerate:FindFirstChildOfClass("ProximityPrompt")
                prompt.HoldDuration = 0.00001
            end
            
            local startTime = tick()
            local maxWaitTime = 1
            
            while not isScrapCollected(scrapGenerate) and (tick() - startTime) < maxWaitTime do
                if moneyValue.Value >= 25 then break end
                holdEKey(0.3)
                task.wait(0.02)
            end
            
            currentScrapIndex = currentScrapIndex + 1
            task.wait(0.1)
            
        else
            teleportTo(TARGET_POSITION)
            task.wait(0.1)
            
            while not player.Backpack:FindFirstChild("Pickaxe") do
                local args = {"Pickaxe", "LINKON_CS"}
                game:GetService("ReplicatedStorage"):WaitForChild("MERCHANT"):WaitForChild("MClientCommunication"):FireServer(unpack(args))
                task.wait(0.05)
                if character:FindFirstChild("Pickaxe") then break end
            end
            
            local pickaxe = player.Backpack:FindFirstChild("Pickaxe")
            if pickaxe then
                humanoidRootPart.Parent:FindFirstChildOfClass("Humanoid"):EquipTool(pickaxe)
                task.wait(0.2)
            end
            
            local oreSystem = workspace:WaitForChild("CoreGameplaySystems"):WaitForChild("OreSystems")
            local allResources = {}
            
            for _, oreFolder in pairs(oreSystem:GetChildren()) do
                if oreFolder.Name == "Diamond" and oreFolder:FindFirstChild("Resources") then
                    for _, resource in pairs(oreFolder.Resources:GetChildren()) do
                        table.insert(allResources, resource)
                    end
                end
            end
            
            local currentResourceIndex = 1
            local cycleAttempts = 0
            local maxCycleAttempts = 3
            
            while countResourcesInBackpack() < 2 do
                if currentResourceIndex > #allResources then
                    cycleAttempts = cycleAttempts + 1
                    
                    if cycleAttempts >= maxCycleAttempts then
                        task.wait(5)
                        cycleAttempts = 0
                        allResources = {}
                        for _, oreFolder in pairs(oreSystem:GetChildren()) do
                            if oreFolder.Name == "Diamond" and oreFolder:FindFirstChild("Resources") then
                                for _, resource in pairs(oreFolder.Resources:GetChildren()) do
                                    table.insert(allResources, resource)
                                end
                            end
                        end
                    end
                    
                    currentResourceIndex = 1
                    task.wait(1)
                end
                
                local currentResource = allResources[currentResourceIndex]
                
                if getResourceTransparency(currentResource) >= 1 then
                    currentResourceIndex = currentResourceIndex + 1
                    task.wait(0.02)
                    continue
                end
                
                if currentResource:IsA("BasePart") then
                    teleportTo(currentResource.Position)
                elseif currentResource:FindFirstChildWhichIsA("BasePart", true) then
                    local part = currentResource:FindFirstChildWhichIsA("BasePart", true)
                    teleportTo(part.Position)
                end
                
                task.wait(0.1)
                
                local prompt = currentResource:FindFirstChildOfClass("ProximityPrompt", true)
                if prompt then
                    prompt.HoldDuration = 0.00001
                end
                
                local miningStartTime = tick()
                local maxMiningTime = 15
                local initialResourceCount = countResourcesInBackpack()
                
                while getResourceTransparency(currentResource) < 1 and (tick() - miningStartTime) < maxMiningTime do
                    holdEKey(0.15)
                    task.wait(0.05)
                    
                    if countResourcesInBackpack() > initialResourceCount then break end
                    if countResourcesInBackpack() >= 2 then break end
                end
                
                currentResourceIndex = currentResourceIndex + 1
                task.wait(0.1)
            end
            
            teleportTo(Vector3.new(313, 24, -571))
            task.wait(2)
            
            teleportTo(TARGET_POSITION)
            task.wait(0.2)
            
            while not player.Backpack:FindFirstChild("Keypad Cracker") do
                local args = {"Keypad Cracker", "BARTON_EC"}
                game:GetService("ReplicatedStorage"):WaitForChild("MERCHANT"):WaitForChild("MClientCommunication"):FireServer(unpack(args))
                task.wait(0.1)
                if character:FindFirstChild("Keypad Cracker") then break end
            end
            
            break
        end
    end
end)
]]

local crackerRunning = false
local function startGetKeypadCracker()
    if crackerRunning then return end
    crackerRunning = true
    
    task.spawn(function()
        loadstring(getKeypadCrackerScript)()
    end)
    
    print("✓ Get Keypad Cracker started (auto farm)")
end

--==============================================================================
--                          CREATE UI
--==============================================================================

-- 1. Get Keypad Cracker (BUTTON - not toggle)
do
    local button = Instance.new("TextButton")
    button.Name = "GetKeypadCrackerButton"
    button.Size = UDim2.new(1, 0, 0, 45)
    button.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    button.BorderSizePixel = 0
    button.ZIndex = 3
    button.Parent = page
    
    Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)
    
    local label = Instance.new("TextLabel")
    label.Text = "Get Keypad Cracker"
    label.Font = Enum.Font.GothamMedium
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Size = UDim2.new(1, -15, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 4
    label.Parent = button
    
    local clickLabel = Instance.new("TextLabel")
    clickLabel.Text = "CLICK"
    clickLabel.Font = Enum.Font.GothamBold
    clickLabel.TextSize = 12
    clickLabel.TextColor3 = Color3.fromRGB(88, 101, 242)
    clickLabel.Size = UDim2.new(0, 60, 1, 0)
    clickLabel.Position = UDim2.new(1, -75, 0, 0)
    clickLabel.BackgroundTransparency = 1
    clickLabel.TextXAlignment = Enum.TextXAlignment.Center
    clickLabel.ZIndex = 4
    clickLabel.Parent = button
    
    button.MouseButton1Click:Connect(function()
        if not crackerRunning then
            startGetKeypadCracker()
            clickLabel.Text = "RUNNING"
            clickLabel.TextColor3 = Color3.fromRGB(46, 204, 113)
        end
    end)
end

-- 2. Open All Doors
Library:CreateToggle(page, "Open All Doors", false, function(enabled)
    if enabled then
        startOpenDoors()
    else
        stopOpenDoors()
    end
end)

-- 3. Close All Doors
Library:CreateToggle(page, "Close All Doors", false, function(enabled)
    if enabled then
        startCloseDoors()
    else
        stopCloseDoors()
    end
end)

-- 4. Auto Booth Processing
Library:CreateToggle(page, "Auto Booth Processing", false, function(enabled)
    if enabled then
        startAutoBoothProcessing()
    else
        stopAutoBoothProcessing()
    end
end)

print("✓ Trolling Auto Module Loaded (4 Scripts)")

return true
