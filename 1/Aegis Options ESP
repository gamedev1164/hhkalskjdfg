-- Aegis ESP Module - With GUI Controls
-- Designed to work inside CoreX GUI

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- Get parent container from CoreX
local ParentContainer = _G.AegisHub and _G.AegisHub.AegisESP

if not ParentContainer then
    warn("CoreX GUI not found! Load the main GUI first.")
    return
end

-- Settings
local Settings = {
    ShowName = false,
    ShowDistance = false,
    ShowHealth = false,
    UseHighlight = false,
    TeamColor = Color3.fromRGB(147, 51, 234), -- Purple
    HighlightTransparency = 0.5,
    TextColor = Color3.fromRGB(147, 51, 234),
    MaxDistance = 5000
}

-- Aegis Teams
local AegisTeams = {
    ["AEGIS Corporation"] = true,
    ["Conference"] = true,
    ["Experiment1"] = true,
    ["Experiment2"] = true,
    ["Insurrectionist"] = true,
    ["Interrogation"] = true,
    ["Interview1"] = true,
    ["Interview2"] = true,
    ["Lesson1"] = true,
    ["Lesson2"] = true,
    ["Patrol1"] = true,
    ["Patrol2"] = true,
    ["Patrol3"] = true,
    ["Patrol4"] = true,
    ["Rally"] = true,
    ["Sewer Dweller"] = true,
    ["The Chairman"] = true,
    ["Training"] = true,
    ["Tryout"] = true,
    ["Voided"] = true
}

local ESPObjects = {}
local UpdateConnection

-- CoreX Style Colors (matching the main GUI)
local Colors = {
    Background = Color3.fromRGB(20, 20, 32),
    Surface = Color3.fromRGB(24, 24, 36),
    SurfaceLight = Color3.fromRGB(35, 35, 42),
    Primary = Color3.fromRGB(147, 51, 234),
    Text = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(180, 180, 200),
}

--[[
    ESP FUNCTIONS
--]]

local function IsAegisTeam(player)
    if not player.Team then return false end
    return AegisTeams[player.Team.Name] == true
end

local function CreateESP(player)
    if player == LocalPlayer then return end
    if not IsAegisTeam(player) then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "AegisESP"
    billboard.AlwaysOnTop = true
    billboard.Size = UDim2.new(0, 200, 0, 100)
    billboard.StudsOffset = Vector3.new(0, -4, 0)
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Settings.TextColor
    textLabel.TextStrokeTransparency = 0.5
    textLabel.TextSize = 14
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextYAlignment = Enum.TextYAlignment.Top
    textLabel.Parent = billboard
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "AegisHighlight"
    highlight.FillColor = Settings.TeamColor
    highlight.OutlineColor = Settings.TeamColor
    highlight.FillTransparency = Settings.HighlightTransparency
    highlight.OutlineTransparency = Settings.HighlightTransparency
    highlight.Enabled = Settings.UseHighlight
    
    ESPObjects[player] = {
        Player = player,
        Billboard = billboard,
        TextLabel = textLabel,
        Highlight = highlight
    }
    
    local function AttachToCharacter()
        local char = player.Character
        if char then
            local head = char:FindFirstChild("Head")
            if head then
                billboard.Adornee = head
                billboard.Parent = head
            end
            highlight.Parent = char
        end
    end
    
    if player.Character then
        AttachToCharacter()
    end
    
    player.CharacterAdded:Connect(AttachToCharacter)
end

local function UpdateESP(espObj)
    if not espObj or not espObj.Player then return end
    
    local player = espObj.Player
    local char = player.Character
    if not char then return end
    
    local humanoid = char:FindFirstChild("Humanoid")
    local rootPart = char:FindFirstChild("HumanoidRootPart")
    
    if not rootPart then return end
    
    local distance = (LocalPlayer.Character and LocalPlayer.Character.HumanoidRootPart)
        and (rootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
        or 0
    
    if distance > Settings.MaxDistance then
        espObj.Billboard.Enabled = false
        espObj.Highlight.Enabled = false
        return
    end
    
    espObj.Billboard.Enabled = true
    espObj.Highlight.Enabled = Settings.UseHighlight
    
    local text = ""
    
    if Settings.ShowName then
        text = player.Name
    end
    
    if Settings.ShowDistance then
        local distText = string.format("[%d]", math.floor(distance))
        text = text == "" and distText or (text .. "\n" .. distText)
    end
    
    if Settings.ShowHealth and humanoid then
        local healthText = string.format("HP: %d/%d", math.floor(humanoid.Health), math.floor(humanoid.MaxHealth))
        text = text == "" and healthText or (text .. "\n" .. healthText)
    end
    
    espObj.TextLabel.Text = text
end

local function RemoveESP(player)
    local espObj = ESPObjects[player]
    if espObj then
        if espObj.Billboard then espObj.Billboard:Destroy() end
        if espObj.Highlight then espObj.Highlight:Destroy() end
        ESPObjects[player] = nil
    end
end

local function InitializeESP()
    for _, player in ipairs(Players:GetPlayers()) do
        task.spawn(function()
            if player.Character then
                CreateESP(player)
            end
            player.CharacterAdded:Connect(function()
                task.wait(0.1)
                RemoveESP(player)
                CreateESP(player)
            end)
        end)
    end
    
    Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function()
            task.wait(0.1)
            CreateESP(player)
        end)
    end)
    
    Players.PlayerRemoving:Connect(RemoveESP)
end

local function StartUpdateLoop()
    if UpdateConnection then return end
    UpdateConnection = RunService.Heartbeat:Connect(function()
        for _, espObj in pairs(ESPObjects) do
            UpdateESP(espObj)
        end
    end)
end

--[[
    COREX-STYLE GUI COMPONENTS
--]]

local ROW_HEIGHT = 23
local SLIDER_ROW_HEIGHT = 25
local CORNER_SMALL = 5

local function CreateToggle(parent, text, defaultValue, callback)
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, ROW_HEIGHT)
    row.BackgroundColor3 = Colors.SurfaceLight
    row.BorderSizePixel = 0
    row.Parent = parent
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, CORNER_SMALL)
    Corner.Parent = row
    
    local box = Instance.new("Frame")
    box.Size = UDim2.new(0, 14, 0, 14)
    box.Position = UDim2.new(0, 6, 0.5, -7)
    box.BackgroundColor3 = defaultValue and Colors.Primary or Color3.fromRGB(55, 55, 68)
    box.BorderSizePixel = 0
    box.Parent = row
    
    local BoxCorner = Instance.new("UICorner")
    BoxCorner.CornerRadius = UDim.new(0, 4)
    BoxCorner.Parent = box
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -28, 1, 0)
    btn.Position = UDim2.new(0, 26, 0, 0)
    btn.BackgroundTransparency = 1
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 9
    btn.TextXAlignment = Enum.TextXAlignment.Left
    btn.TextColor3 = Colors.Text
    btn.Text = text
    btn.Parent = row
    
    local active = defaultValue
    
    local function set(on)
        active = on
        box.BackgroundColor3 = on and Colors.Primary or Color3.fromRGB(55, 55, 68)
        callback(on)
    end
    
    btn.MouseButton1Click:Connect(function()
        set(not active)
    end)
    
    box.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            set(not active)
        end
    end)
    
    row.MouseEnter:Connect(function()
        row.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    end)
    
    row.MouseLeave:Connect(function()
        row.BackgroundColor3 = Colors.SurfaceLight
    end)
    
    return row
end

local function CreateSlider(parent, text, min, max, default, callback)
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, SLIDER_ROW_HEIGHT)
    row.BackgroundColor3 = Colors.SurfaceLight
    row.BorderSizePixel = 0
    row.Parent = parent
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, CORNER_SMALL)
    Corner.Parent = row
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 70, 1, 0)
    label.Position = UDim2.new(0, 8, 0, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 9
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextColor3 = Colors.Text
    label.Text = text
    label.Parent = row
    
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(0, 80, 0, 8)
    sliderFrame.Position = UDim2.new(0, 80, 0.5, -4)
    sliderFrame.BackgroundColor3 = Color3.fromRGB(55, 55, 68)
    sliderFrame.BorderSizePixel = 0
    sliderFrame.Parent = row
    
    local SliderCorner = Instance.new("UICorner")
    SliderCorner.CornerRadius = UDim.new(0, 4)
    SliderCorner.Parent = sliderFrame
    
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(0.5, 0, 1, 0)
    fill.BackgroundColor3 = Colors.Primary
    fill.BorderSizePixel = 0
    fill.Parent = sliderFrame
    
    local FillCorner = Instance.new("UICorner")
    FillCorner.CornerRadius = UDim.new(0, 4)
    FillCorner.Parent = fill
    
    local valLabel = Instance.new("TextLabel")
    valLabel.Size = UDim2.new(0, 30, 1, 0)
    valLabel.Position = UDim2.new(1, -35, 0, 0)
    valLabel.BackgroundTransparency = 1
    valLabel.Font = Enum.Font.GothamBold
    valLabel.TextSize = 9
    valLabel.TextColor3 = Colors.Primary
    valLabel.TextXAlignment = Enum.TextXAlignment.Right
    valLabel.Parent = row
    
    local current = default
    local sliderDragging = false
    
    local function updateSlider()
        local alpha = (current - min) / (max - min)
        fill.Size = UDim2.new(math.clamp(alpha, 0, 1), 0, 1, 0)
        valLabel.Text = max <= 1 and string.format("%.2f", current) or tostring(math.floor(current))
    end
    
    local function setSliderFromX(x)
        local alpha = math.clamp((x - sliderFrame.AbsolutePosition.X) / sliderFrame.AbsoluteSize.X, 0, 1)
        current = min + (max - min) * alpha
        updateSlider()
        callback(current)
    end
    
    sliderFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            sliderDragging = true
            setSliderFromX(input.Position.X)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if sliderDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            setSliderFromX(input.Position.X)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            sliderDragging = false
        end
    end)
    
    row.MouseEnter:Connect(function()
        row.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    end)
    
    row.MouseLeave:Connect(function()
        row.BackgroundColor3 = Colors.SurfaceLight
    end)
    
    updateSlider()
    return row
end

--[[
    BUILD GUI
--]]

local function BuildGUI()
    -- Main scroll for controls
    local ScrollFrame = Instance.new("ScrollingFrame")
    ScrollFrame.Size = UDim2.new(1, 0, 1, 0)
    ScrollFrame.BackgroundTransparency = 1
    ScrollFrame.BorderSizePixel = 0
    ScrollFrame.ScrollBarThickness = 3
    ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(120, 120, 135)
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    ScrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ScrollFrame.Parent = ParentContainer
    
    local Layout = Instance.new("UIListLayout")
    Layout.Padding = UDim.new(0, 4)
    Layout.SortOrder = Enum.SortOrder.LayoutOrder
    Layout.Parent = ScrollFrame
    
    -- Highlight Toggle
    CreateToggle(ScrollFrame, "Show Highlight", Settings.UseHighlight, function(value)
        Settings.UseHighlight = value
        for _, obj in pairs(ESPObjects) do
            if obj.Highlight then
                obj.Highlight.Enabled = value
            end
        end
    end)
    
    -- Name Toggle
    CreateToggle(ScrollFrame, "Show Name", Settings.ShowName, function(value)
        Settings.ShowName = value
    end)
    
    -- Distance Toggle
    CreateToggle(ScrollFrame, "Show Distance", Settings.ShowDistance, function(value)
        Settings.ShowDistance = value
    end)
    
    -- Health Toggle
    CreateToggle(ScrollFrame, "Show Health", Settings.ShowHealth, function(value)
        Settings.ShowHealth = value
    end)
    
    -- Transparency Slider
    CreateSlider(ScrollFrame, "Transparency", 0, 100, Settings.HighlightTransparency * 100, function(value)
        Settings.HighlightTransparency = value / 100
        for _, obj in pairs(ESPObjects) do
            if obj.Highlight then
                obj.Highlight.FillTransparency = Settings.HighlightTransparency
                obj.Highlight.OutlineTransparency = Settings.HighlightTransparency
            end
        end
    end)
    
    -- Max Distance Slider
    CreateSlider(ScrollFrame, "Max Distance", 100, 10000, Settings.MaxDistance, function(value)
        Settings.MaxDistance = value
    end)
end

--[[
    INITIALIZE
--]]

InitializeESP()
StartUpdateLoop()
BuildGUI()

print("[Aegis ESP] Loaded with GUI controls!")
print("Tracking 20 Aegis teams")
print("All features disabled by default - enable what you need!")

return {
    Settings = Settings,
    ESPObjects = ESPObjects
}
