--==============================================================================
--                    AEGIS HUB - MOVEMENT MODULE (COMBINED)
--==============================================================================
-- PRESETS - Customize default values here
local PRESETS = {
    CFRAME_FLY = {
        DEFAULT = 200,
        MIN = 1,
        MAX = 500
    },
    FREECAM = {
        DEFAULT_SPEED = 200,
        MIN_SPEED = 1,
        MAX_SPEED = 500,
        FOV_BOOST = 1.5,
        MOUSE_SENSITIVITY_BOOST = 1.5
    },
    FOV = {
        DEFAULT = 70,
        MIN = 10,
        MAX = 120
    }
}

local AegisHub = _G.AegisHub
if not AegisHub or not AegisHub.MovementPage then 
    warn("Aegis Hub not loaded!") 
    return 
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local page = AegisHub.MovementPage
local Library = AegisHub.Library

-- UI Reference (declared before hotkey handler needs it)
local cframeFlyToggleRef = nil
local freecamControlRef = nil

-- State
local State = {
    -- CFrame Fly
    cframeFlyEnabled = false,
    cframeFlySpeed = PRESETS.CFRAME_FLY.DEFAULT,
    cframeFlyConn = nil,
    cframeFlyKeys = {W = false, A = false, S = false, D = false, Q = false, E = false, Shift = false},
    cframeFlyHotkey = nil,
    
    -- FreeCam
    freecamEnabled = false,
    freecamSpeed = PRESETS.FREECAM.DEFAULT_SPEED,
    freecamCF = nil,
    freecamOrig = nil,
    freecamOrigFOV = nil,
    freecamOrigMouseSens = nil,
    freecamKeys = {W = false, A = false, S = false, D = false, Q = false, E = false, Shift = false},
    freecamHotkey = nil,
    charOrig = nil,
    rmbDown = false,
    yaw = 0,
    pitch = 0,
    
    -- Infinite Jump
    infJumpEnabled = false,
    
    -- FOV
    fovEnabled = false,
    fovValue = PRESETS.FOV.DEFAULT,
    
    -- God Mode
    godModeEnabled = false,
    godModeConn = nil,
    
    capturingHotkey = false,
    connections = {}
}

-- Helper: Get Humanoid
local function getHumanoid()
    if player.Character then
        return player.Character:FindFirstChildOfClass("Humanoid")
    end
end

--==============================================================================
--                          CFRAME FLY
--==============================================================================

local function setCFrameFlyKey(key, state)
    State.cframeFlyKeys[key.Name] = state
end

local function enableCFrameFly()
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    State.cframeFlyConn = RunService.Heartbeat:Connect(function(dt)
        if not State.cframeFlyEnabled then return end
        
        local cam = Workspace.CurrentCamera
        if not cam then return end
        
        local cf = hrp.CFrame
        local lookVec = cam.CFrame.LookVector
        local rightVec = cam.CFrame.RightVector
        
        local spd = State.cframeFlySpeed
        if State.cframeFlyKeys.Shift then spd = spd * 2 end
        
        local move = Vector3.new(0, 0, 0)
        if State.cframeFlyKeys.W then move = move + lookVec end
        if State.cframeFlyKeys.S then move = move - lookVec end
        if State.cframeFlyKeys.D then move = move + rightVec end
        if State.cframeFlyKeys.A then move = move - rightVec end
        if State.cframeFlyKeys.E then move = move + Vector3.new(0, 1, 0) end
        if State.cframeFlyKeys.Q then move = move - Vector3.new(0, 1, 0) end
        
        if move.Magnitude > 0 then
            move = move.Unit * spd * dt
            hrp.CFrame = cf + move
        end
    end)
    
    table.insert(State.connections, State.cframeFlyConn)
end

local function disableCFrameFly()
    if State.cframeFlyConn then
        State.cframeFlyConn:Disconnect()
        State.cframeFlyConn = nil
    end
end

--==============================================================================
--                          FREECAM
--==============================================================================

local function setCamKey(key, state)
    State.freecamKeys[key.Name] = state
end

local function freezeCharacter(freeze)
    local char = player.Character
    if not char then return end
    
    if freeze then
        if not State.charOrig then
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                State.charOrig = hrp.CFrame
                hrp.Anchored = true
            end
        end
    else
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp and State.charOrig then
            hrp.Anchored = false
            State.charOrig = nil
        end
    end
end

local function enableFreeCam()
    local cam = Workspace.CurrentCamera
    if not cam then return end
    
    if not State.freecamOrig then
        State.freecamOrig = {
            CameraType = cam.CameraType,
            CFrame = cam.CFrame,
            Subject = cam.CameraSubject
        }
    end
    
    -- Store and boost FOV by preset multiplier
    if not State.freecamOrigFOV then
        State.freecamOrigFOV = cam.FieldOfView
    end
    cam.FieldOfView = State.freecamOrigFOV * PRESETS.FREECAM.FOV_BOOST
    
    -- Store original mouse sensitivity (simulated through rotation speed multiplier)
    State.freecamOrigMouseSens = 1.0
    
    State.freecamCF = cam.CFrame
    cam.CameraType = Enum.CameraType.Scriptable
    
    -- Calculate initial yaw/pitch from camera look vector
    local look = cam.CFrame.LookVector
    State.yaw = math.atan2(-look.X, -look.Z)
    State.pitch = math.asin(math.clamp(look.Y, -0.999, 0.999))
    
    freezeCharacter(true)
end

local function disableFreeCam()
    local cam = Workspace.CurrentCamera
    if not cam then return end
    
    local o = State.freecamOrig
    if o then
        cam.CameraType = o.CameraType
        cam.CFrame = o.CFrame
        cam.CameraSubject = o.Subject
    else
        cam.CameraType = Enum.CameraType.Custom
    end
    
    -- Restore original FOV
    if State.freecamOrigFOV then
        cam.FieldOfView = State.freecamOrigFOV
        State.freecamOrigFOV = nil
    end
    
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    State.rmbDown = false
    State.freecamCF = nil
    State.freecamOrig = nil
    State.freecamOrigMouseSens = nil
    
    freezeCharacter(false)
end

local function teleportToCam()
    if not State.freecamEnabled or not State.freecamCF then return end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    hrp.CFrame = State.freecamCF
end

-- FreeCam Render Loop
table.insert(State.connections, RunService.RenderStepped:Connect(function(dt)
    if not State.freecamEnabled then return end
    
    local cam = Workspace.CurrentCamera
    if not cam or not State.freecamCF then return end
    
    -- Handle right-click rotation with preset sensitivity boost
    if State.rmbDown then
        local delta = UserInputService:GetMouseDelta()
        State.yaw = State.yaw - delta.X * 0.0035 * PRESETS.FREECAM.MOUSE_SENSITIVITY_BOOST
        State.pitch = math.clamp(State.pitch - delta.Y * 0.0035 * PRESETS.FREECAM.MOUSE_SENSITIVITY_BOOST, math.rad(-80), math.rad(80))
    end
    
    -- Build rotation from yaw/pitch
    local cy, sy = math.cos(State.yaw), math.sin(State.yaw)
    local cp, sp = math.cos(State.pitch), math.sin(State.pitch)
    
    local forward = Vector3.new(sy * cp, sp, cy * cp)
    local right = Vector3.new(cy, 0, -sy)
    local up = Vector3.new(-sy * sp, cp, -cy * sp)
    
    -- Movement
    local spd = State.freecamSpeed
    if State.freecamKeys.Shift then spd = spd * 2 end
    
    local move = Vector3.new(0,0,0)
    if State.freecamKeys.W then move = move + forward end
    if State.freecamKeys.S then move = move - forward end
    if State.freecamKeys.D then move = move + right end
    if State.freecamKeys.A then move = move - right end
    if State.freecamKeys.E then move = move + up end
    if State.freecamKeys.Q then move = move - up end
    
    if move.Magnitude > 0 then
        move = move.Unit * spd * dt
        State.freecamCF = State.freecamCF + move
    end
    
    -- Apply camera CFrame
    local rot = CFrame.new(0, 0, 0, right.X, up.X, -forward.X, right.Y, up.Y, -forward.Y, right.Z, up.Z, -forward.Z)
    cam.CFrame = CFrame.new(State.freecamCF.Position) * rot
end))

-- FreeCam Input
table.insert(State.connections, UserInputService.InputBegan:Connect(function(input, gpe)
    if not State.freecamEnabled then return end
    
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        State.rmbDown = true
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCurrentPosition
    elseif input.UserInputType == Enum.UserInputType.Keyboard then
        setCamKey(input.KeyCode, true)
    end
end))

table.insert(State.connections, UserInputService.InputEnded:Connect(function(input)
    if not State.freecamEnabled then return end
    
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        State.rmbDown = false
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    elseif input.UserInputType == Enum.UserInputType.Keyboard then
        setCamKey(input.KeyCode, false)
    end
end))

-- FreeCam Hotkey toggle
table.insert(State.connections, UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe or input.UserInputType ~= Enum.UserInputType.Keyboard then return end
    
    if not State.capturingHotkey and State.freecamHotkey and input.KeyCode == State.freecamHotkey then
        State.freecamEnabled = not State.freecamEnabled
        if State.freecamEnabled then
            enableFreeCam()
        else
            disableFreeCam()
        end
        
        if freecamControlRef then
            freecamControlRef.setToggle(State.freecamEnabled)
        end
    end
end))

-- FreeCam Death Handler
player.CharacterAdded:Connect(function()
    if State.freecamEnabled then
        State.freecamEnabled = false
        disableFreeCam()
        if freecamControlRef then
            freecamControlRef.setToggle(false)
        end
    end
end)

if player.Character then
    local hum = player.Character:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.Died:Connect(function()
            if State.freecamEnabled then
                State.freecamEnabled = false
                disableFreeCam()
                if freecamControlRef then
                    freecamControlRef.setToggle(false)
                end
            end
        end)
    end
end

--==============================================================================
--                          FOV
--==============================================================================

local function enableFOV()
    local cam = Workspace.CurrentCamera
    if cam then cam.FieldOfView = State.fovValue end
end

local function disableFOV()
    local cam = Workspace.CurrentCamera
    if cam then cam.FieldOfView = 70 end
end

--==============================================================================
--                          GOD MODE
--==============================================================================

local function enableGodMode()
    State.godModeConn = RunService.Heartbeat:Connect(function()
        local hum = getHumanoid()
        if hum then hum.Health = hum.MaxHealth end
    end)
    table.insert(State.connections, State.godModeConn)
end

local function disableGodMode()
    if State.godModeConn then
        State.godModeConn:Disconnect()
        State.godModeConn = nil
    end
end

--==============================================================================
--                          HOTKEY HANDLERS
--==============================================================================

-- CFrame Fly Hotkey
table.insert(State.connections, UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe or input.UserInputType ~= Enum.UserInputType.Keyboard then return end
    
    if not State.capturingHotkey and State.cframeFlyHotkey and input.KeyCode == State.cframeFlyHotkey then
        State.cframeFlyEnabled = not State.cframeFlyEnabled
        if State.cframeFlyEnabled then
            enableCFrameFly()
        else
            disableCFrameFly()
        end
        
        if cframeFlyToggleRef then
            cframeFlyToggleRef.setToggle(State.cframeFlyEnabled)
        end
    end
end))

-- CFrame Fly Input
table.insert(State.connections, UserInputService.InputBegan:Connect(function(input, gpe)
    if not State.cframeFlyEnabled or gpe then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        setCFrameFlyKey(input.KeyCode, true)
    end
end))

table.insert(State.connections, UserInputService.InputEnded:Connect(function(input)
    if not State.cframeFlyEnabled then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        setCFrameFlyKey(input.KeyCode, false)
    end
end))

-- Infinite Jump
table.insert(State.connections, UserInputService.JumpRequest:Connect(function()
    if not State.infJumpEnabled then return end
    local hum = getHumanoid()
    if hum then
        hum:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end))

--==============================================================================
--                          CREATE UI
--==============================================================================

-- ORDER: CFrame Fly, FreeCam, Infinite Jump, FOV, God Mode

-- 1. CFRAME FLY
do
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundColor3 = Color3.fromRGB(34, 34, 40)
    frame.BorderSizePixel = 0
    frame.ZIndex = 5
    frame.Parent = page
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)
    
    -- Label
    local label = Instance.new("TextLabel")
    label.Text = "CFrame Fly"
    label.Font = Enum.Font.GothamMedium
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(240, 240, 240)
    label.Size = UDim2.new(0, 120, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = frame
    
    -- Slider
    local barBg = Instance.new("Frame")
    barBg.Size = UDim2.new(0, 200, 0, 12)
    barBg.Position = UDim2.new(0, 140, 0, 24)
    barBg.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    barBg.BorderSizePixel = 0
    barBg.ZIndex = 6
    barBg.Parent = frame
    Instance.new("UICorner", barBg).CornerRadius = UDim.new(1, 0)
    
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(0.4, 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    fill.BorderSizePixel = 0
    fill.ZIndex = 7
    fill.Parent = barBg
    Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)
    
    local grabber = Instance.new("Frame")
    grabber.Size = UDim2.new(0, 18, 0, 18)
    grabber.AnchorPoint = Vector2.new(0.5, 0.5)
    grabber.Position = UDim2.new(1, 0, 0.5, 0)
    grabber.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
    grabber.ZIndex = 8
    grabber.Parent = fill
    Instance.new("UICorner", grabber).CornerRadius = UDim.new(1, 0)
    
    local valueLabel = Instance.new("TextLabel")
    valueLabel.Text = "200"
    valueLabel.Font = Enum.Font.GothamBold
    valueLabel.TextSize = 14
    valueLabel.TextColor3 = Color3.fromRGB(138, 43, 226)
    valueLabel.Size = UDim2.new(0, 50, 0, 30)
    valueLabel.Position = UDim2.new(0, 350, 0, 15)
    valueLabel.BackgroundTransparency = 1
    valueLabel.TextXAlignment = Enum.TextXAlignment.Left
    valueLabel.ZIndex = 6
    valueLabel.Parent = frame
    
    -- Hotkey Button
    local hotkeyBtn = Instance.new("TextButton")
    hotkeyBtn.Size = UDim2.new(0, 50, 0, 26)
    hotkeyBtn.Position = UDim2.new(1, -125, 0.5, -13)
    hotkeyBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    hotkeyBtn.BorderSizePixel = 0
    hotkeyBtn.Font = Enum.Font.GothamBold
    hotkeyBtn.TextSize = 11
    hotkeyBtn.TextColor3 = Color3.fromRGB(138, 43, 226)
    hotkeyBtn.Text = State.cframeFlyHotkey and State.cframeFlyHotkey.Name or "None"
    hotkeyBtn.ZIndex = 6
    hotkeyBtn.Parent = frame
    Instance.new("UICorner", hotkeyBtn).CornerRadius = UDim.new(0, 6)
    
    hotkeyBtn.MouseButton1Click:Connect(function()
        State.capturingHotkey = true
        hotkeyBtn.Text = "..."
        hotkeyBtn.TextColor3 = Color3.fromRGB(255, 140, 50)
    end)
    
    local hotkeyConn = UserInputService.InputBegan:Connect(function(input, gpe)
        if not State.capturingHotkey then return end
        if input.UserInputType ~= Enum.UserInputType.Keyboard then return end
        if input.KeyCode == Enum.KeyCode.Escape then
            State.capturingHotkey = false
            hotkeyBtn.Text = State.cframeFlyHotkey and State.cframeFlyHotkey.Name or "None"
            hotkeyBtn.TextColor3 = Color3.fromRGB(138, 43, 226)
            return
        end
        
        State.cframeFlyHotkey = input.KeyCode
        hotkeyBtn.Text = input.KeyCode.Name
        hotkeyBtn.TextColor3 = Color3.fromRGB(138, 43, 226)
        State.capturingHotkey = false
    end)
    table.insert(State.connections, hotkeyConn)
    
    -- Toggle Switch
    local switch = Instance.new("TextButton")
    switch.Text = ""
    switch.Size = UDim2.new(0, 50, 0, 26)
    switch.Position = UDim2.new(1, -65, 0.5, -13)
    switch.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    switch.AutoButtonColor = false
    switch.ZIndex = 6
    switch.Parent = frame
    Instance.new("UICorner", switch).CornerRadius = UDim.new(1, 0)
    
    local dot = Instance.new("Frame")
    dot.Size = UDim2.new(0, 20, 0, 20)
    dot.Position = UDim2.new(0, 3, 0.5, -10)
    dot.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
    dot.BorderSizePixel = 0
    dot.ZIndex = 7
    dot.Parent = switch
    Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)
    
    switch.MouseButton1Click:Connect(function()
        State.cframeFlyEnabled = not State.cframeFlyEnabled
        if State.cframeFlyEnabled then enableCFrameFly() else disableCFrameFly() end
        
        local newColor = State.cframeFlyEnabled and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(50, 50, 60)
        local newPos = State.cframeFlyEnabled and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10)
        TweenService:Create(switch, TweenInfo.new(0.2), {BackgroundColor3 = newColor}):Play()
        TweenService:Create(dot, TweenInfo.new(0.2), {Position = newPos}):Play()
    end)
    
    cframeFlyToggleRef = {
        setToggle = function(on)
            State.cframeFlyEnabled = on
            local newColor = on and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(50, 50, 60)
            local newPos = on and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10)
            TweenService:Create(switch, TweenInfo.new(0.2), {BackgroundColor3 = newColor}):Play()
            TweenService:Create(dot, TweenInfo.new(0.2), {Position = newPos}):Play()
        end
    }
    
    -- Slider logic
    local dragging = false
    local function updateSlider(input)
        local sizeX = barBg.AbsoluteSize.X
        local pos = math.clamp((input.Position.X - barBg.AbsolutePosition.X) / sizeX, 0, 1)
        local value = math.floor(1 + (499 * pos))
        fill.Size = UDim2.new(pos, 0, 1, 0)
        valueLabel.Text = tostring(value)
        State.cframeFlySpeed = value
    end
    
    barBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            updateSlider(input)
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 22, 0, 22)}):Play()
        end
    end)
    
    fill.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            updateSlider(input)
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 22, 0, 22)}):Play()
        end
    end)
    
    grabber.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 22, 0, 22)}):Play()
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 18, 0, 18)}):Play()
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            updateSlider(input)
        end
    end)
end

-- 2. FREECAM
do
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 60)
    frame.BackgroundColor3 = Color3.fromRGB(34, 34, 40)
    frame.BorderSizePixel = 0
    frame.ZIndex = 5
    frame.Parent = page
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)
    
    -- Label
    local label = Instance.new("TextLabel")
    label.Text = "FreeCam"
    label.Font = Enum.Font.GothamMedium
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(240, 240, 240)
    label.Size = UDim2.new(0, 120, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 6
    label.Parent = frame
    
    -- Slider
    local barBg = Instance.new("Frame")
    barBg.Size = UDim2.new(0, 200, 0, 12)
    barBg.Position = UDim2.new(0, 140, 0, 24)
    barBg.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    barBg.BorderSizePixel = 0
    barBg.ZIndex = 6
    barBg.Parent = frame
    Instance.new("UICorner", barBg).CornerRadius = UDim.new(1, 0)
    
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(0.4, 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    fill.BorderSizePixel = 0
    fill.ZIndex = 7
    fill.Parent = barBg
    Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)
    
    local grabber = Instance.new("Frame")
    grabber.Size = UDim2.new(0, 18, 0, 18)
    grabber.AnchorPoint = Vector2.new(0.5, 0.5)
    grabber.Position = UDim2.new(1, 0, 0.5, 0)
    grabber.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
    grabber.ZIndex = 8
    grabber.Parent = fill
    Instance.new("UICorner", grabber).CornerRadius = UDim.new(1, 0)
    
    local valueLabel = Instance.new("TextLabel")
    valueLabel.Text = "200"
    valueLabel.Font = Enum.Font.GothamBold
    valueLabel.TextSize = 14
    valueLabel.TextColor3 = Color3.fromRGB(138, 43, 226)
    valueLabel.Size = UDim2.new(0, 50, 0, 30)
    valueLabel.Position = UDim2.new(0, 350, 0, 15)
    valueLabel.BackgroundTransparency = 1
    valueLabel.TextXAlignment = Enum.TextXAlignment.Left
    valueLabel.ZIndex = 6
    valueLabel.Parent = frame
    
    -- TP to Cam Button
    local tpBtn = Instance.new("TextButton")
    tpBtn.Size = UDim2.new(0, 80, 0, 26)
    tpBtn.Position = UDim2.new(0, 410, 0.5, -13)
    tpBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    tpBtn.BorderSizePixel = 0
    tpBtn.Font = Enum.Font.GothamBold
    tpBtn.TextSize = 11
    tpBtn.TextColor3 = Color3.fromRGB(138, 43, 226)
    tpBtn.Text = "TP to Cam"
    tpBtn.ZIndex = 6
    tpBtn.Parent = frame
    Instance.new("UICorner", tpBtn).CornerRadius = UDim.new(0, 6)
    
    tpBtn.MouseEnter:Connect(function()
        tpBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 48)
    end)
    
    tpBtn.MouseLeave:Connect(function()
        tpBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    end)
    
    tpBtn.MouseButton1Click:Connect(function()
        teleportToCam()
        State.freecamEnabled = false
        disableFreeCam()
        if freecamControlRef then
            freecamControlRef.setToggle(false)
        end
    end)
    
    -- Hotkey Button
    local hotkeyBtn = Instance.new("TextButton")
    hotkeyBtn.Size = UDim2.new(0, 50, 0, 26)
    hotkeyBtn.Position = UDim2.new(1, -125, 0.5, -13)
    hotkeyBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    hotkeyBtn.BorderSizePixel = 0
    hotkeyBtn.Font = Enum.Font.GothamBold
    hotkeyBtn.TextSize = 11
    hotkeyBtn.TextColor3 = Color3.fromRGB(138, 43, 226)
    hotkeyBtn.Text = State.freecamHotkey and State.freecamHotkey.Name or "None"
    hotkeyBtn.ZIndex = 6
    hotkeyBtn.Parent = frame
    Instance.new("UICorner", hotkeyBtn).CornerRadius = UDim.new(0, 6)
    
    hotkeyBtn.MouseButton1Click:Connect(function()
        State.capturingHotkey = true
        hotkeyBtn.Text = "..."
        hotkeyBtn.TextColor3 = Color3.fromRGB(255, 140, 50)
    end)
    
    local hotkeyConn = UserInputService.InputBegan:Connect(function(input, gpe)
        if not State.capturingHotkey then return end
        if input.UserInputType ~= Enum.UserInputType.Keyboard then return end
        if input.KeyCode == Enum.KeyCode.Escape then
            State.capturingHotkey = false
            hotkeyBtn.Text = State.freecamHotkey and State.freecamHotkey.Name or "None"
            hotkeyBtn.TextColor3 = Color3.fromRGB(138, 43, 226)
            return
        end
        
        State.freecamHotkey = input.KeyCode
        hotkeyBtn.Text = input.KeyCode.Name
        hotkeyBtn.TextColor3 = Color3.fromRGB(138, 43, 226)
        State.capturingHotkey = false
    end)
    table.insert(State.connections, hotkeyConn)
    
    -- Toggle Switch
    local switch = Instance.new("TextButton")
    switch.Text = ""
    switch.Size = UDim2.new(0, 50, 0, 26)
    switch.Position = UDim2.new(1, -65, 0.5, -13)
    switch.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    switch.AutoButtonColor = false
    switch.ZIndex = 6
    switch.Parent = frame
    Instance.new("UICorner", switch).CornerRadius = UDim.new(1, 0)
    
    local dot = Instance.new("Frame")
    dot.Size = UDim2.new(0, 20, 0, 20)
    dot.Position = UDim2.new(0, 3, 0.5, -10)
    dot.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
    dot.BorderSizePixel = 0
    dot.ZIndex = 7
    dot.Parent = switch
    Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)
    
    switch.MouseButton1Click:Connect(function()
        State.freecamEnabled = not State.freecamEnabled
        if State.freecamEnabled then enableFreeCam() else disableFreeCam() end
        
        local newColor = State.freecamEnabled and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(50, 50, 60)
        local newPos = State.freecamEnabled and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10)
        TweenService:Create(switch, TweenInfo.new(0.2), {BackgroundColor3 = newColor}):Play()
        TweenService:Create(dot, TweenInfo.new(0.2), {Position = newPos}):Play()
    end)
    
    freecamControlRef = {
        setToggle = function(on)
            State.freecamEnabled = on
            local newColor = on and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(50, 50, 60)
            local newPos = on and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10)
            TweenService:Create(switch, TweenInfo.new(0.2), {BackgroundColor3 = newColor}):Play()
            TweenService:Create(dot, TweenInfo.new(0.2), {Position = newPos}):Play()
        end
    }
    
    -- Slider logic
    local dragging = false
    local function updateSlider(input)
        local sizeX = barBg.AbsoluteSize.X
        local pos = math.clamp((input.Position.X - barBg.AbsolutePosition.X) / sizeX, 0, 1)
        local value = math.floor(1 + (499 * pos))
        fill.Size = UDim2.new(pos, 0, 1, 0)
        valueLabel.Text = tostring(value)
        State.freecamSpeed = value
    end
    
    barBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            updateSlider(input)
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 22, 0, 22)}):Play()
        end
    end)
    
    fill.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            updateSlider(input)
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 22, 0, 22)}):Play()
        end
    end)
    
    grabber.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 22, 0, 22)}):Play()
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
            TweenService:Create(grabber, TweenInfo.new(0.15), {Size = UDim2.new(0, 18, 0, 18)}):Play()
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            updateSlider(input)
        end
    end)
end

-- 3. INFINITE JUMP
Library:CreateToggle(page, "Infinite Jump", false, function(v)
    State.infJumpEnabled = v
end)

-- 4. FOV
Library:CreateToggleSlider(page, "FOV", PRESETS.FOV.MIN, PRESETS.FOV.MAX, PRESETS.FOV.DEFAULT, 
    function(enabled)
        State.fovEnabled = enabled
        if enabled then enableFOV() else disableFOV() end
    end,
    function(value)
        State.fovValue = value
        if State.fovEnabled then
            local cam = Workspace.CurrentCamera
            if cam then cam.FieldOfView = value end
        end
    end
)

-- 5. GOD MODE
Library:CreateToggle(page, "God Mode", false, function(v)
    State.godModeEnabled = v
    if v then enableGodMode() else disableGodMode() end
end)

print("âœ“ Movement Module Loaded (Combined)")

return true
