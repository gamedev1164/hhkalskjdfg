--==============================================================================
--                    AEGIS HUB - TROLLING FLING MODULE
--==============================================================================

local AegisHub = _G.AegisHub
if not AegisHub or not AegisHub.TrollingFling then 
    warn("Aegis Hub not loaded!") 
    return 
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local page = AegisHub.TrollingFling
local Library = AegisHub.Library

-- Aegis Team Names
local AEGIS_TEAMS = {
    "AEGIS Corporation",
    "Conference",
    "Experiment1",
    "Experiment2",
    "Insurrectionist",
    "Interrogation",
    "Interview1",
    "Interview2",
    "Lesson1",
    "Lesson2",
    "Patrol1",
    "Patrol2",
    "Patrol3",
    "Patrol4",
    "Rally",
    "Sewer Dweller",
    "Subject",
    "The Chairman",
    "Training"
}

local TRAINING_TEAMS = {"Training", "Lesson1", "Lesson2"}

-- Fling Config
local UPDATE_INTERVAL = 0.01
local SWITCH_INTERVAL = 2
local SPIN_SPEED = 7000
local PUSH_SPEED = 800
local INSIDE_OFFSET = Vector3.new(0, 0, 0)

-- State
local State = {
    flingAll = false,
    flingWastelanders = false,
    flingAegis = false,
    flingTraining = false,
    
    updateElapsed = 0,
    switchElapsed = 0,
    currentTargetHRP = nil,
    ax = 0,
    ay = 0,
    az = 0,
    
    flingConnection = nil,
    trainingButton = nil,
    trainingFlashConnection = nil
}

-- Helper: Get HumanoidRootPart
local function getHRP(character)
    return character and character:FindFirstChild("HumanoidRootPart")
end

-- Check if player is on Aegis team
local function isAegisPlayer(plr)
    if not plr or not plr.Team then return false end
    
    for _, teamName in ipairs(AEGIS_TEAMS) do
        if plr.Team.Name == teamName then
            return true
        end
    end
    return false
end

-- Check if player is on Training team
local function isTrainingPlayer(plr)
    if not plr or not plr.Team then return false end
    
    for _, teamName in ipairs(TRAINING_TEAMS) do
        if plr.Team.Name == teamName then
            return true
        end
    end
    return false
end

-- Check if local player is on Training team
local function isLocalPlayerTraining()
    return isTrainingPlayer(player)
end

-- Get random target based on active mode
local function getRandomTargetHRP()
    local candidates = {}
    
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player then
            local char = plr.Character
            local hum = char and char:FindFirstChildOfClass("Humanoid")
            local hrp = getHRP(char)
            
            if hum and hrp and hum.Health > 0 then
                local shouldTarget = false
                
                if State.flingAll then
                    shouldTarget = true
                elseif State.flingWastelanders then
                    shouldTarget = not isAegisPlayer(plr)
                elseif State.flingAegis then
                    shouldTarget = isAegisPlayer(plr)
                elseif State.flingTraining then
                    shouldTarget = isTrainingPlayer(plr)
                end
                
                if shouldTarget then
                    table.insert(candidates, hrp)
                end
            end
        end
    end
    
    if #candidates == 0 then
        return nil
    end
    
    return candidates[math.random(1, #candidates)]
end

-- Start Fling
local function startFling()
    if State.flingConnection then return end
    
    State.updateElapsed = 0
    State.switchElapsed = 0
    State.currentTargetHRP = nil
    State.ax = 0
    State.ay = 0
    State.az = 0
    
    State.flingConnection = RunService.Heartbeat:Connect(function(dt)
        State.updateElapsed = State.updateElapsed + dt
        State.switchElapsed = State.switchElapsed + dt
        
        -- Pick new target every SWITCH_INTERVAL seconds
        if not State.currentTargetHRP or State.switchElapsed >= SWITCH_INTERVAL then
            State.currentTargetHRP = getRandomTargetHRP()
            State.switchElapsed = 0
        end
        
        if State.updateElapsed < UPDATE_INTERVAL then return end
        State.updateElapsed = 0
        
        local myChar = player.Character
        local myHRP = getHRP(myChar)
        if not myHRP then return end
        if not State.currentTargetHRP then return end
        
        -- Validate target still exists
        if not State.currentTargetHRP.Parent then
            State.currentTargetHRP = nil
            return
        end
        
        -- Spin math
        local rps = math.rad(SPIN_SPEED)
        State.ax = State.ax + rps * dt
        State.ay = State.ay + rps * dt
        State.az = State.az + rps * dt
        local spinCF = CFrame.Angles(State.ax, State.ay, State.az)
        
        -- Teleport inside target + spin
        local baseCF = State.currentTargetHRP.CFrame * CFrame.new(INSIDE_OFFSET)
        myHRP.CFrame = baseCF * spinCF
        
        -- Speed/push
        myHRP.AssemblyLinearVelocity = State.currentTargetHRP.CFrame.LookVector * PUSH_SPEED
    end)
    
    print("✓ Fling started")
end

-- Stop Fling
local function stopFling()
    if State.flingConnection then
        State.flingConnection:Disconnect()
        State.flingConnection = nil
    end
    
    State.currentTargetHRP = nil
    print("✓ Fling stopped")
end

-- Update fling state (ensures only one mode is active)
local function updateFlingState(mode)
    -- Turn off all other modes
    if mode ~= "all" then State.flingAll = false end
    if mode ~= "wastelanders" then State.flingWastelanders = false end
    if mode ~= "aegis" then State.flingAegis = false end
    if mode ~= "training" then State.flingTraining = false end
    
    -- Check if any mode is active
    local anyActive = State.flingAll or State.flingWastelanders or State.flingAegis or State.flingTraining
    
    if anyActive then
        startFling()
    else
        stopFling()
    end
end

-- Update Training button visibility and flashing
local function updateTrainingButton()
    if not State.trainingButton then return end
    
    local shouldShow = isLocalPlayerTraining()
    State.trainingButton.Visible = shouldShow
    
    if shouldShow and State.flingTraining then
        -- Start flashing
        if not State.trainingFlashConnection then
            local flashing = true
            State.trainingFlashConnection = RunService.Heartbeat:Connect(function()
                local time = tick()
                local alpha = (math.sin(time * 2) + 1) / 2  -- Slow sine wave 0-1
                
                -- Flash between purple and darker purple
                local color = Color3.fromRGB(
                    138 + (50 - 138) * alpha,
                    43 + (30 - 43) * alpha,
                    226 + (80 - 226) * alpha
                )
                
                if State.trainingButton and State.trainingButton:FindFirstChild("switch") then
                    State.trainingButton.switch.BackgroundColor3 = color
                end
            end)
        end
    else
        -- Stop flashing
        if State.trainingFlashConnection then
            State.trainingFlashConnection:Disconnect()
            State.trainingFlashConnection = nil
        end
    end
end

-- Monitor team changes
player:GetPropertyChangedSignal("Team"):Connect(function()
    updateTrainingButton()
end)

--==============================================================================
--                          CREATE UI
--==============================================================================

-- Fling All
Library:CreateToggle(page, "Fling All", false, function(v)
    State.flingAll = v
    updateFlingState("all")
end)

-- Fling Wastelanders
Library:CreateToggle(page, "Fling Wastelanders", false, function(v)
    State.flingWastelanders = v
    updateFlingState("wastelanders")
end)

-- Fling Aegis
Library:CreateToggle(page, "Fling Aegis", false, function(v)
    State.flingAegis = v
    updateFlingState("aegis")
end)

-- Fling Training (conditional visibility)
do
    local trainingToggle = Library:CreateToggle(page, "Fling Training", false, function(v)
        State.flingTraining = v
        updateFlingState("training")
        updateTrainingButton()
    end)
    
    State.trainingButton = trainingToggle
    updateTrainingButton()
end

print("✓ Trolling Fling Module Loaded")

return true
