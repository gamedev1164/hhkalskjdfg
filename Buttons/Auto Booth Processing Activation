--==============================================================================
--                    OPTIMIZED AUTO BOOTH PROCESSING
--==============================================================================
-- Reduces lag and works with FreeCam by tracking HRP position

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local ROOT = workspace:WaitForChild("Booths")
local TARGET_NAME = "Processing_BoothSystem"

local State = {
    running = false,
    cachedParts = {},
    lastCacheTime = 0,
    connection = nil
}

-- Get all touch parts (cached for 10 seconds to reduce lag)
local function getTouchParts()
    local currentTime = tick()
    
    -- Use cache if less than 10 seconds old
    if currentTime - State.lastCacheTime < 10 and #State.cachedParts > 0 then
        return State.cachedParts
    end
    
    local parts = {}
    local seen = {}
    
    -- Find all Processing_BoothSystem objects
    for _, obj in ipairs(ROOT:GetDescendants()) do
        if obj.Name == TARGET_NAME then
            -- Find TouchTransmitter parts under this system
            for _, descendant in ipairs(obj:GetDescendants()) do
                if descendant:IsA("TouchTransmitter") then
                    local part = descendant.Parent
                    if part and part:IsA("BasePart") and not seen[part] then
                        seen[part] = true
                        table.insert(parts, part)
                    end
                end
            end
        end
    end
    
    State.cachedParts = parts
    State.lastCacheTime = currentTime
    
    return parts
end

-- Get current HRP (always tracks body, even in FreeCam)
local function getHRP()
    local char = player.Character
    if char then
        return char:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

-- Start auto booth processing
local function startProcessing()
    if State.connection then return end
    
    State.running = true
    
    -- Use Heartbeat for better performance (runs every frame)
    local frameCount = 0
    State.connection = RunService.Heartbeat:Connect(function()
        frameCount = frameCount + 1
        
        -- Only process every 60 frames (~1 second at 60 FPS)
        if frameCount < 60 then return end
        frameCount = 0
        
        local hrp = getHRP()
        if not hrp then return end
        
        local parts = getTouchParts()
        
        -- Fire touch on all parts at once (no wait between)
        for _, part in ipairs(parts) do
            if part and part.Parent then
                pcall(function()
                    firetouchinterest(hrp, part, 0)
                    firetouchinterest(hrp, part, 1)
                end)
            end
        end
    end)
    
    print("✓ Auto Booth Processing started")
end

-- Stop auto booth processing
local function stopProcessing()
    if State.connection then
        State.connection:Disconnect()
        State.connection = nil
    end
    
    State.running = false
    print("✓ Auto Booth Processing stopped")
end

-- Clear cache when character respawns
player.CharacterAdded:Connect(function()
    State.cachedParts = {}
    State.lastCacheTime = 0
end)

-- Expose functions globally
_G.AutoBoothProcessing = {
    start = startProcessing,
    stop = stopProcessing,
    isRunning = function() return State.running end
}

return {
    start = startProcessing,
    stop = stopProcessing
}
