-- MODULE 4: Complete Auto Mining with Purity Checking
-- Mines Fedorlite, auto-deletes low purity (≤63), stops at 15 high purity (≥64)

local Module4 = {}

-- Services
local Players = game:GetService("Players")

-- Configuration
Module4.Config = {
    FEDORLITE_NAME = "Fedorlite",
    RESOURCE_NAME = "Resource",
    HOLD_DURATION = 0.5,
    RETRY_DELAY = 0.1,
    MIN_PURITY = 64,
    TARGET_FEDORLITE_COUNT = 15, -- Changed from 20 to 15
    BLACKLISTED_ROCK_POSITIONS = {
        Vector3.new(-493.100006, -152.199997, -673.5),
        Vector3.new(-384.786926, -152.350006, -658.049988)
    }
}

-- Initialize
function Module4:Init()
    self.player = Players.LocalPlayer
    self.character = self.player.Character or self.player.CharacterAdded:Wait()
    self.humanoidRootPart = self.character:WaitForChild("HumanoidRootPart")
    self.isAlive = true
    
    -- Handle respawn
    self.player.CharacterAdded:Connect(function(newCharacter)
        self.character = newCharacter
        self.humanoidRootPart = newCharacter:WaitForChild("HumanoidRootPart")
    end)
    
    -- Death detection
    self.character:WaitForChild("Humanoid").Died:Connect(function()
        print("[Module 4] ☠ PLAYER DIED - STOPPING SCRIPT ☠")
        self.isAlive = false
    end)
    
    -- Auto-delete low purity items
    local backpack = self.player:WaitForChild("Backpack")
    backpack.ChildAdded:Connect(function(item)
        if item.Name == "Fedorlite" or item.Name == "Resource" then
            task.wait(0.5)
            
            local purity = item:GetAttribute("ChemicallyPure")
            local oreName = item:GetAttribute("OreName")
            
            if (oreName == "Fedorlite" or item.Name == "Fedorlite") and purity then
                print("[Module 4] Found " .. item.Name .. " with purity: " .. purity)
                
                if purity <= 63 then
                    print("[Module 4] ✗ DELETING (purity " .. purity .. " ≤ 63)")
                    item:Destroy()
                else
                    print("[Module 4] ✓ KEEPING (purity " .. purity .. " ≥ 64)")
                end
            end
        end
    end)
    
    print("[Module 4] Initialized - Auto Purity Checker Active")
end

-- Check if blacklisted Fedorlite
function Module4:IsBlacklistedFedorlite(fedorliteModel)
    for _, obj in pairs(fedorliteModel:GetDescendants()) do
        if obj.Name == "Rock" and obj:IsA("BasePart") then
            local rockPos = obj.Position
            for _, blacklistedPos in ipairs(self.Config.BLACKLISTED_ROCK_POSITIONS) do
                if (rockPos - blacklistedPos).Magnitude < 0.5 then
                    return true
                end
            end
        end
    end
    return false
end

-- Count high purity Fedorlite
function Module4:CountHighPurityFedorlite()
    local backpack = self.player:WaitForChild("Backpack")
    local count = 0
    
    for _, item in pairs(backpack:GetChildren()) do
        if item.Name == "Fedorlite" or item.Name == "Resource" then
            local purity = item:GetAttribute("ChemicallyPure")
            local oreName = item:GetAttribute("OreName")
            
            if (oreName == "Fedorlite" or item.Name == "Fedorlite") and purity and purity >= self.Config.MIN_PURITY then
                count = count + 1
            end
        end
    end
    
    return count
end

-- Check if Fuel is 2000 or more
function Module4:CheckFuelLevel()
    print("[Module 4] Checking fuel level...")
    
    -- Find FuelMonitor in workspace
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj.Name == "Fuel" and obj:IsA("TextLabel") then
            local fuelText = obj.Text
            local fuelValue = tonumber(fuelText)
            
            if fuelValue then
                print("[Module 4] Found Fuel TextLabel - Value: " .. fuelValue)
                
                if fuelValue >= 2000 then
                    print("[Module 4] ✓ Fuel >= 2000 - SKIPPING MINING")
                    return true
                else
                    print("[Module 4] ✗ Fuel < 2000 - MINING REQUIRED")
                    return false
                end
            end
        end
    end
    
    print("[Module 4] ⚠ Fuel TextLabel not found - proceeding with mining")
    return false
end

-- Check if has pickaxe
function Module4:HasPickaxe()
    local backpack = self.player:WaitForChild("Backpack")
    
    if backpack:FindFirstChild("Pickaxe") then
        return true
    end
    
    for _, item in pairs(self.character:GetChildren()) do
        if item:IsA("Tool") and item.Name == "Pickaxe" then
            return true
        end
    end
    
    return false
end

-- Equip pickaxe
function Module4:EquipPickaxe()
    local backpack = self.player:WaitForChild("Backpack")
    local pickaxe = backpack:FindFirstChild("Pickaxe")
    
    if pickaxe then
        self.character.Humanoid:EquipTool(pickaxe)
        return true
    end
    
    for _, item in pairs(self.character:GetChildren()) do
        if item:IsA("Tool") and item.Name == "Pickaxe" then
            return true
        end
    end
    
    return false
end

-- Find Fedorlite models
function Module4:FindFedorliteModels()
    local fedorlites = {}
    local workspace = game:GetService("Workspace")
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj.Name == self.Config.FEDORLITE_NAME then
            if not self:IsBlacklistedFedorlite(obj) then
                table.insert(fedorlites, obj)
            end
        end
    end
    
    return fedorlites
end

-- Find resources in Fedorlite
function Module4:FindResourcesInFedorlite(fedorliteModel)
    local resources = {}
    
    for _, obj in pairs(fedorliteModel:GetDescendants()) do
        if obj.Name == self.Config.RESOURCE_NAME then
            table.insert(resources, obj)
        end
    end
    
    return resources
end

-- Mine a resource
function Module4:MineResource(resourceObject)
    if not self.isAlive then
        return false
    end
    
    local resourcePart = resourceObject:IsA("BasePart") and resourceObject or resourceObject:FindFirstChildWhichIsA("BasePart", true)
    
    if not resourcePart or resourcePart.Transparency >= 1 then
        return false
    end
    
    -- Find ProximityPrompt
    local proximityPrompt = nil
    local proximityAttachment = resourceObject:FindFirstChild("ProximityAttachment", true)
    
    if proximityAttachment then
        proximityPrompt = proximityAttachment:FindFirstChildOfClass("ProximityPrompt")
    end
    
    if not proximityPrompt then
        proximityPrompt = resourceObject:FindFirstChildOfClass("ProximityPrompt", true)
    end
    
    if not proximityPrompt then
        return false
    end
    
    -- Calculate position
    local resourcePosition = resourcePart.Position
    local targetPosition = resourcePosition + Vector3.new(0, 2, 0)
    
    -- Monitor transparency
    local mined = false
    local connection = resourcePart:GetPropertyChangedSignal("Transparency"):Connect(function()
        if resourcePart.Transparency >= 1 then
            mined = true
        end
    end)
    
    -- Teleport loop
    local keepTeleporting = true
    task.spawn(function()
        while keepTeleporting do
            if not self.isAlive then
                keepTeleporting = false
                break
            end
            self.humanoidRootPart.CFrame = CFrame.new(resourcePart.Position + Vector3.new(0, 2, 0))
            wait(0.001)
        end
    end)
    
    -- Mine
    local attempts = 0
    while not mined and attempts < 20 do
        if not self.isAlive then
            keepTeleporting = false
            connection:Disconnect()
            return false
        end
        
        attempts = attempts + 1
        fireproximityprompt(proximityPrompt, self.Config.HOLD_DURATION)
        wait(self.Config.HOLD_DURATION + 0.1)
        
        if resourcePart.Transparency >= 1 then
            mined = true
            break
        end
        
        if not proximityPrompt or not proximityPrompt.Parent then
            mined = true
            break
        end
        
        wait(self.Config.RETRY_DELAY)
    end
    
    keepTeleporting = false
    connection:Disconnect()
    
    return mined
end

-- Main mining loop
function Module4:MineUntilTarget()
    print("[Module 4] Starting mining - Target: 15 high purity Fedorlite (64+)")
    
    local cycleCount = 0
    
    while true do
        if not self.isAlive then
            print("[Module 4] Player died - stopping")
            return false
        end
        
        cycleCount = cycleCount + 1
        
        local currentCount = self:CountHighPurityFedorlite()
        print("[Module 4] Cycle #" .. cycleCount .. " | High purity: " .. currentCount .. "/15")
        
        if currentCount >= self.Config.TARGET_FEDORLITE_COUNT then
            print("[Module 4] ========================================")
            print("[Module 4] ✓✓✓ TARGET REACHED! 15+ HIGH PURITY ✓✓✓")
            print("[Module 4] ========================================")
            return true
        end
        
        local fedorlites = self:FindFedorliteModels()
        
        if #fedorlites == 0 then
            print("[Module 4] No Fedorlite models found, waiting...")
            wait(5)
        else
            local minedThisCycle = false
            
            for _, fedorlite in ipairs(fedorlites) do
                if not self.isAlive then
                    return false
                end
                
                if self:CountHighPurityFedorlite() >= self.Config.TARGET_FEDORLITE_COUNT then
                    return true
                end
                
                local resources = self:FindResourcesInFedorlite(fedorlite)
                
                if #resources > 0 then
                    self.character = self.player.Character or self.player.CharacterAdded:Wait()
                    self.humanoidRootPart = self.character:WaitForChild("HumanoidRootPart")
                    self:EquipPickaxe()
                    
                    for _, resource in ipairs(resources) do
                        local success = self:MineResource(resource)
                        if success then
                            minedThisCycle = true
                            break
                        end
                    end
                    
                    if minedThisCycle then
                        break
                    end
                end
                
                task.wait()
            end
            
            if not minedThisCycle then
                wait(3)
            end
        end
        
        task.wait()
    end
end

-- Main execution
function Module4:Run()
    print("[Module 4] ========================================")
    print("[Module 4] STARTING AUTO MINING")
    print("[Module 4] ========================================")
    
    -- Check fuel level first
    if self:CheckFuelLevel() then
        print("[Module 4] Fuel level sufficient - skipping mining")
        print("[Module 4] Teleporting to final location: -125 5 -790")
        self.humanoidRootPart.CFrame = CFrame.new(-125, 5, -790)
        task.wait()
        
        print("[Module 4] ========================================")
        print("[Module 4] LOADING NEXT SCRIPT...")
        print("[Module 4] ========================================")
        
        loadstring(game:HttpGet("https://raw.githubusercontent.com/gamedev1164/hhkalskjdfg/refs/heads/main/Reactor/Module%205", true))()
        
        print("[Module 4] ========================================")
        print("[Module 4] NEXT SCRIPT LOADED - MODULE 4 STOPPING")
        print("[Module 4] ========================================")
        return
    end
    
    -- Fuel < 2000, proceed with mining
    while not self:HasPickaxe() do
        print("[Module 4] Waiting for pickaxe...")
        wait(1)
    end
    
    print("[Module 4] Pickaxe detected! Starting mining...")
    self:EquipPickaxe()
    wait(0.5)
    
    self:MineUntilTarget()
    
    print("[Module 4] ========================================")
    print("[Module 4] MINING COMPLETE - 15 HIGH PURITY COLLECTED")
    print("[Module 4] ========================================")
    
    -- Teleport to final location
    print("[Module 4] Teleporting to final location: -125 5 -790")
    self.humanoidRootPart.CFrame = CFrame.new(-125, 5, -790)
    
    task.wait()
    
    print("[Module 4] ========================================")
    print("[Module 4] LOADING NEXT SCRIPT...")
    print("[Module 4] ========================================")
    
    -- Load Module 5
    loadstring(game:HttpGet("https://raw.githubusercontent.com/gamedev1164/hhkalskjdfg/refs/heads/main/Reactor/Module%205", true))()
    
    print("[Module 4] ========================================")
    print("[Module 4] NEXT SCRIPT LOADED - MODULE 4 STOPPING")
    print("[Module 4] ========================================")
end

-- AUTO START
print("========================================")
print("MODULE 4: Auto Mining System")
print("========================================")

Module4:Init()
Module4:Run()

print("========================================")
print("MODULE 4: COMPLETE")
print("========================================")
