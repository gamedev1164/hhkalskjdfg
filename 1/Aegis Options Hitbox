-- Aegis Hitbox Expander - With GUI Controls
-- Designed to work inside CoreX GUI

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer

-- Get parent container from CoreX
local ParentContainer = _G.AegisHub and _G.AegisHub.AegisHitbox

if not ParentContainer then
    warn("CoreX GUI not found! Load the main GUI first.")
    return
end

-- Settings
local Settings = {
    Enabled = false, -- Start disabled
    Mode = "Full Body", -- "Head Only" or "Full Body"
    Size = 5,
    Transparency = 0.5, -- Body part transparency
    ShowHighlight = true,
    HighlightColor = Color3.fromRGB(255, 80, 80), -- Red (different from ESP purple)
    HighlightTransparency = 0.5 -- Both fill and outline transparency (combined)
}

-- Aegis Teams
local AegisTeams = {
    ["AEGIS Corporation"] = true,
    ["Conference"] = true,
    ["Experiment1"] = true,
    ["Experiment2"] = true,
    ["Insurrectionist"] = true,
    ["Interrogation"] = true,
    ["Interview1"] = true,
    ["Interview2"] = true,
    ["Lesson1"] = true,
    ["Lesson2"] = true,
    ["Patrol1"] = true,
    ["Patrol2"] = true,
    ["Patrol3"] = true,
    ["Patrol4"] = true,
    ["Rally"] = true,
    ["Sewer Dweller"] = true,
    ["The Chairman"] = true,
    ["Training"] = true,
    ["Tryout"] = true,
    ["Voided"] = true
}

-- Storage
local OriginalSizes = {}
local OriginalTransparencies = {}
local Highlights = {}
local UpdateConnection

-- All body parts to expand (Full Body)
local AllBodyParts = {
    "Head", "Torso", "UpperTorso", "LowerTorso", "HumanoidRootPart",
    "Left Arm", "Right Arm", "LeftUpperArm", "LeftLowerArm", "LeftHand",
    "RightUpperArm", "RightLowerArm", "RightHand", "Left Leg", "Right Leg",
    "LeftUpperLeg", "LeftLowerLeg", "LeftFoot", "RightUpperLeg", "RightLowerLeg", "RightFoot"
}

-- Head only parts
local HeadOnlyParts = {
    "Head"
}

-- CoreX Style Colors
local Colors = {
    Background = Color3.fromRGB(20, 20, 32),
    Surface = Color3.fromRGB(24, 24, 36),
    SurfaceLight = Color3.fromRGB(35, 35, 42),
    Primary = Color3.fromRGB(147, 51, 234),
    Text = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(180, 180, 200),
}

--[[
    HITBOX FUNCTIONS
--]]

local function IsAegisTeam(player)
    if not player.Team then return false end
    return AegisTeams[player.Team.Name] == true
end

local function ClearHighlights()
    for _, highlight in pairs(Highlights) do
        pcall(function() highlight:Destroy() end)
    end
    Highlights = {}
end

local function ResetHitboxes()
    -- Restore original sizes
    for part, size in pairs(OriginalSizes) do
        pcall(function()
            if part and part.Parent then
                part.Size = size
            end
        end)
    end
    OriginalSizes = {}
    
    -- Restore original transparencies
    for part, trans in pairs(OriginalTransparencies) do
        pcall(function()
            if part and part.Parent then
                part.Transparency = trans
            end
        end)
    end
    OriginalTransparencies = {}
    
    ClearHighlights()
end

local function UpdateHitboxes()
    if not Settings.Enabled then return end
    
    -- Get parts list based on mode
    local partsToExpand = Settings.Mode == "Head Only" and HeadOnlyParts or AllBodyParts
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and IsAegisTeam(player) then
            local char = player.Character
            
            for _, partName in ipairs(partsToExpand) do
                local part = char:FindFirstChild(partName)
                if part and part:IsA("BasePart") then
                    -- Store original size
                    if not OriginalSizes[part] then
                        OriginalSizes[part] = part.Size
                    end
                    
                    -- Store original transparency
                    if not OriginalTransparencies[part] then
                        OriginalTransparencies[part] = part.Transparency
                    end
                    
                    -- Expand hitbox
                    part.Size = Vector3.new(Settings.Size, Settings.Size, Settings.Size)
                    part.Transparency = Settings.Transparency
                    part.CanCollide = false
                    
                    -- Add/Update highlight
                    if Settings.ShowHighlight then
                        local key = char.Name .. "_" .. partName
                        if not Highlights[key] or not Highlights[key].Parent then
                            local highlight = Instance.new("Highlight")
                            highlight.Adornee = part
                            highlight.FillColor = Settings.HighlightColor
                            highlight.FillTransparency = Settings.HighlightTransparency
                            highlight.OutlineColor = Settings.HighlightColor
                            highlight.OutlineTransparency = Settings.HighlightTransparency
                            highlight.DepthMode = Enum.HighlightDepthMode.Occluded
                            highlight.Parent = part
                            Highlights[key] = highlight
                        else
                            -- Update existing highlight transparency (both fill and outline)
                            Highlights[key].FillTransparency = Settings.HighlightTransparency
                            Highlights[key].OutlineTransparency = Settings.HighlightTransparency
                        end
                    end
                end
            end
        end
    end
end

local function StartUpdateLoop()
    if UpdateConnection then return end
    UpdateConnection = RunService.Heartbeat:Connect(function()
        UpdateHitboxes()
    end)
end

local function StopUpdateLoop()
    if UpdateConnection then
        UpdateConnection:Disconnect()
        UpdateConnection = nil
    end
    ResetHitboxes()
end

--[[
    COREX-STYLE GUI COMPONENTS
--]]

local ROW_HEIGHT = 23
local SLIDER_ROW_HEIGHT = 25
local CORNER_SMALL = 5

local function CreateModeSelector(parent, text, options, defaultOption, callback)
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, ROW_HEIGHT)
    row.BackgroundColor3 = Colors.SurfaceLight
    row.BorderSizePixel = 0
    row.Parent = parent
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, CORNER_SMALL)
    Corner.Parent = row
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 70, 1, 0)
    label.Position = UDim2.new(0, 8, 0, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 9
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextColor3 = Colors.Text
    label.Text = text
    label.Parent = row
    
    -- Create buttons for each option
    local buttonWidth = (1 - 0.5) / #options
    local currentSelection = defaultOption
    local buttons = {}
    
    for i, option in ipairs(options) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(buttonWidth, -4, 0, 16)
        btn.Position = UDim2.new(0.5 + (i - 1) * buttonWidth, 2, 0.5, -8)
        btn.BackgroundColor3 = option == currentSelection and Colors.Primary or Color3.fromRGB(55, 55, 68)
        btn.BorderSizePixel = 0
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 8
        btn.TextColor3 = Colors.Text
        btn.Text = option
        btn.Parent = row
        
        local BtnCorner = Instance.new("UICorner")
        BtnCorner.CornerRadius = UDim.new(0, 4)
        BtnCorner.Parent = btn
        
        buttons[option] = btn
        
        btn.MouseButton1Click:Connect(function()
            currentSelection = option
            callback(option)
            
            -- Update button colors
            for opt, button in pairs(buttons) do
                button.BackgroundColor3 = opt == currentSelection and Colors.Primary or Color3.fromRGB(55, 55, 68)
            end
        end)
    end
    
    row.MouseEnter:Connect(function()
        row.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    end)
    
    row.MouseLeave:Connect(function()
        row.BackgroundColor3 = Colors.SurfaceLight
    end)
    
    return row
end

local function CreateToggle(parent, text, defaultValue, callback)
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, ROW_HEIGHT)
    row.BackgroundColor3 = Colors.SurfaceLight
    row.BorderSizePixel = 0
    row.Parent = parent
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, CORNER_SMALL)
    Corner.Parent = row
    
    local box = Instance.new("Frame")
    box.Size = UDim2.new(0, 14, 0, 14)
    box.Position = UDim2.new(0, 6, 0.5, -7)
    box.BackgroundColor3 = defaultValue and Colors.Primary or Color3.fromRGB(55, 55, 68)
    box.BorderSizePixel = 0
    box.Parent = row
    
    local BoxCorner = Instance.new("UICorner")
    BoxCorner.CornerRadius = UDim.new(0, 4)
    BoxCorner.Parent = box
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -28, 1, 0)
    btn.Position = UDim2.new(0, 26, 0, 0)
    btn.BackgroundTransparency = 1
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 9
    btn.TextXAlignment = Enum.TextXAlignment.Left
    btn.TextColor3 = Colors.Text
    btn.Text = text
    btn.Parent = row
    
    local active = defaultValue
    
    local function set(on)
        active = on
        box.BackgroundColor3 = on and Colors.Primary or Color3.fromRGB(55, 55, 68)
        callback(on)
    end
    
    btn.MouseButton1Click:Connect(function()
        set(not active)
    end)
    
    box.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            set(not active)
        end
    end)
    
    row.MouseEnter:Connect(function()
        row.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    end)
    
    row.MouseLeave:Connect(function()
        row.BackgroundColor3 = Colors.SurfaceLight
    end)
    
    return row
end

local function CreateSlider(parent, text, min, max, default, callback)
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, SLIDER_ROW_HEIGHT)
    row.BackgroundColor3 = Colors.SurfaceLight
    row.BorderSizePixel = 0
    row.Parent = parent
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, CORNER_SMALL)
    Corner.Parent = row
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 70, 1, 0)
    label.Position = UDim2.new(0, 8, 0, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamBold
    label.TextSize = 9
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextColor3 = Colors.Text
    label.Text = text
    label.Parent = row
    
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(0, 80, 0, 8)
    sliderFrame.Position = UDim2.new(0, 80, 0.5, -4)
    sliderFrame.BackgroundColor3 = Color3.fromRGB(55, 55, 68)
    sliderFrame.BorderSizePixel = 0
    sliderFrame.Parent = row
    
    local SliderCorner = Instance.new("UICorner")
    SliderCorner.CornerRadius = UDim.new(0, 4)
    SliderCorner.Parent = sliderFrame
    
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new(0.5, 0, 1, 0)
    fill.BackgroundColor3 = Colors.Primary
    fill.BorderSizePixel = 0
    fill.Parent = sliderFrame
    
    local FillCorner = Instance.new("UICorner")
    FillCorner.CornerRadius = UDim.new(0, 4)
    FillCorner.Parent = fill
    
    local valLabel = Instance.new("TextLabel")
    valLabel.Size = UDim2.new(0, 30, 1, 0)
    valLabel.Position = UDim2.new(1, -35, 0, 0)
    valLabel.BackgroundTransparency = 1
    valLabel.Font = Enum.Font.GothamBold
    valLabel.TextSize = 9
    valLabel.TextColor3 = Colors.Primary
    valLabel.TextXAlignment = Enum.TextXAlignment.Right
    valLabel.Parent = row
    
    local current = default
    local sliderDragging = false
    
    local function updateSlider()
        local alpha = (current - min) / (max - min)
        fill.Size = UDim2.new(math.clamp(alpha, 0, 1), 0, 1, 0)
        valLabel.Text = max <= 1 and string.format("%.2f", current) or tostring(math.floor(current))
    end
    
    local function setSliderFromX(x)
        local alpha = math.clamp((x - sliderFrame.AbsolutePosition.X) / sliderFrame.AbsoluteSize.X, 0, 1)
        current = min + (max - min) * alpha
        updateSlider()
        callback(current)
    end
    
    sliderFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            sliderDragging = true
            setSliderFromX(input.Position.X)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if sliderDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            setSliderFromX(input.Position.X)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            sliderDragging = false
        end
    end)
    
    row.MouseEnter:Connect(function()
        row.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    end)
    
    row.MouseLeave:Connect(function()
        row.BackgroundColor3 = Colors.SurfaceLight
    end)
    
    updateSlider()
    return row
end

--[[
    BUILD GUI
--]]

local function BuildGUI()
    -- Main scroll for controls
    local ScrollFrame = Instance.new("ScrollingFrame")
    ScrollFrame.Size = UDim2.new(1, 0, 1, 0)
    ScrollFrame.BackgroundTransparency = 1
    ScrollFrame.BorderSizePixel = 0
    ScrollFrame.ScrollBarThickness = 3
    ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(120, 120, 135)
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    ScrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ScrollFrame.Parent = ParentContainer
    
    local Layout = Instance.new("UIListLayout")
    Layout.Padding = UDim.new(0, 4)
    Layout.SortOrder = Enum.SortOrder.LayoutOrder
    Layout.Parent = ScrollFrame
    
    -- Enable Toggle
    CreateToggle(ScrollFrame, "Enable Hitbox Expander", Settings.Enabled, function(value)
        Settings.Enabled = value
        if value then
            StartUpdateLoop()
        else
            StopUpdateLoop()
        end
    end)
    
    -- Mode Selector (Head Only / Full Body)
    CreateModeSelector(ScrollFrame, "Expansion Mode", {"Head Only", "Full Body"}, Settings.Mode, function(value)
        Settings.Mode = value
        -- Clear existing highlights when switching modes
        ClearHighlights()
        ResetHitboxes()
    end)
    
    -- Show Highlight Toggle
    CreateToggle(ScrollFrame, "Show Highlight", Settings.ShowHighlight, function(value)
        Settings.ShowHighlight = value
        if not value then
            ClearHighlights()
        end
    end)
    
    -- Size Slider
    CreateSlider(ScrollFrame, "Hitbox Size", 2, 20, Settings.Size, function(value)
        Settings.Size = value
    end)
    
    -- Body Part Transparency Slider
    CreateSlider(ScrollFrame, "Part Transparency", 0, 100, Settings.Transparency * 100, function(value)
        Settings.Transparency = value / 100
        -- Update all existing parts
        for part, _ in pairs(OriginalSizes) do
            if part and part.Parent then
                part.Transparency = Settings.Transparency
            end
        end
    end)
    
    -- Highlight Transparency Slider (controls both fill and outline)
    CreateSlider(ScrollFrame, "Highlight Transparency", 0, 100, Settings.HighlightTransparency * 100, function(value)
        Settings.HighlightTransparency = value / 100
        -- Update all existing highlights (both fill and outline)
        for _, highlight in pairs(Highlights) do
            if highlight and highlight.Parent then
                highlight.FillTransparency = Settings.HighlightTransparency
                highlight.OutlineTransparency = Settings.HighlightTransparency
            end
        end
    end)
end

--[[
    INITIALIZE
--]]

BuildGUI()

-- Register cleanup function
local function Cleanup()
    -- Stop update loop
    if UpdateConnection then
        UpdateConnection:Disconnect()
        UpdateConnection = nil
    end
    
    -- Reset all hitboxes
    ResetHitboxes()
    
    print("[Aegis Hitbox] Cleaned up successfully!")
end

-- Register cleanup in global table
if _G.AegisHub then
    _G.AegisHub.AegisHitbox_Cleanup = Cleanup
end

print("[Aegis Hitbox] Loaded with GUI controls!")
print("Tracking 20 Aegis teams")
print("Red highlights - Toggle to enable!")
print("Mode: " .. Settings.Mode)

return {
    Settings = Settings,
    OriginalSizes = OriginalSizes,
    OriginalTransparencies = OriginalTransparencies,
    Highlights = Highlights,
    Cleanup = Cleanup
}
