-- MODULE 5: Freecam Slider Interaction (ULTRA FAST)
-- Instant camera teleports, stays in freecam for all sliders

local Module5 = {}

-- Services
local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Initialize
function Module5:Init()
    self.player = Players.LocalPlayer
    self.character = self.player.Character or self.player.CharacterAdded:Wait()
    self.humanoidRootPart = self.character:WaitForChild("HumanoidRootPart")
end

-- Check if Filter Replacement is in inventory
function Module5:HasFilterReplacement()
    local backpack = self.player.Backpack
    if backpack:FindFirstChild("Filter Replacement") then
        return true
    end
    
    if self.character:FindFirstChild("Filter Replacement") then
        return true
    end
    
    return false
end

-- Equip Filter Replacement
function Module5:EquipFilterReplacement()
    local backpack = self.player.Backpack
    local filterTool = backpack:FindFirstChild("Filter Replacement")
    
    if filterTool then
        self.character.Humanoid:EquipTool(filterTool)
        return true
    end
    
    return false
end

-- Left click
function Module5:LeftClick()
    local camera = workspace.CurrentCamera
    local screenSize = camera.ViewportSize
    local centerX = screenSize.X / 2
    local centerY = screenSize.Y / 2
    
    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
    wait(0.05)
    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)
end

-- Check for nearby players within 300 studs
function Module5:FindNearbyPlayers()
    local nearbyPlayers = {}
    local myPosition = self.humanoidRootPart.Position
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= self.player and otherPlayer.Character then
            local otherRoot = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            if otherRoot then
                local distance = (otherRoot.Position - myPosition).Magnitude
                if distance <= 300 then
                    table.insert(nearbyPlayers, otherPlayer)
                end
            end
        end
    end
    
    return nearbyPlayers
end

-- Check if Resource is in inventory
function Module5:HasResource()
    local backpack = self.player.Backpack
    if backpack:FindFirstChild("Resource") then
        return true
    end
    
    if self.character:FindFirstChild("Resource") then
        return true
    end
    
    return false
end

-- Equip Resource
function Module5:EquipResource()
    local backpack = self.player.Backpack
    local resourceTool = backpack:FindFirstChild("Resource")
    
    if resourceTool then
        self.character.Humanoid:EquipTool(resourceTool)
        return true
    end
    
    return false
end

-- Hold E for 1 second
function Module5:HoldE()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    wait(1)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

-- Find KnobSliderEntity by world pivot position
function Module5:FindKnobSliderByPivot(targetPivot)
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj.Name == "KnobSliderEntity" and (obj:IsA("Model") or obj:IsA("Folder")) then
            local pivot = obj:GetPivot().Position
            local distance = (pivot - targetPivot).Magnitude
            if distance < 2 then
                return obj
            end
        end
    end
    return nil
end

-- Perform ONE slider interaction (camera stays active)
function Module5:DoSlider(knobSlider, nubbinName, camera)
    -- Find WaitingSliderPart
    local slidables = knobSlider:FindFirstChild("Slidables")
    if not slidables then return end
    
    local waitingSliderPart = slidables:FindFirstChild("WaitingSliderPart")
    if not waitingSliderPart then return end
    
    -- Modify DragDetector
    local dragDetector = slidables:FindFirstChild("DragDetector")
    local originalMaxDistance = nil
    
    if dragDetector then
        originalMaxDistance = dragDetector.MaxActivationDistance
        dragDetector.MaxActivationDistance = 10000
    end
    
    -- Find nubbin
    local nubbin = nil
    if nubbinName == "NubbinOff" then
        nubbin = knobSlider:FindFirstChild("NubbinOff")
    else
        local nubbins = knobSlider:FindFirstChild("Nubbins")
        if nubbins then nubbin = nubbins:FindFirstChild(nubbinName) end
    end
    
    if not nubbin then return end
    
    -- INSTANT camera teleport to WaitingSliderPart
    local sliderPos = waitingSliderPart.Position
    camera.CFrame = CFrame.new(Vector3.new(sliderPos.X - 3, sliderPos.Y, sliderPos.Z), sliderPos)
    wait(0.1) -- Let camera settle
    
    -- Get WaitingSliderPart screen position and move mouse there
    local sliderScreenPos = camera:WorldToScreenPoint(sliderPos)
    VirtualInputManager:SendMouseMoveEvent(sliderScreenPos.X, sliderScreenPos.Y, game)
    wait(0.1)
    
    -- Click and hold at slider position
    VirtualInputManager:SendMouseButtonEvent(sliderScreenPos.X, sliderScreenPos.Y, 0, true, game, 0)
    wait(0.2)
    
    -- INSTANT camera teleport to Nubbin
    local nubbinPos = nubbin.Position
    camera.CFrame = CFrame.new(Vector3.new(nubbinPos.X - 3, nubbinPos.Y, nubbinPos.Z), nubbinPos)
    wait(0.1) -- Let camera settle
    
    -- Get Nubbin screen position and move mouse there (while still holding)
    local nubbinScreenPos = camera:WorldToScreenPoint(nubbinPos)
    VirtualInputManager:SendMouseMoveEvent(nubbinScreenPos.X, nubbinScreenPos.Y, game)
    wait(0.2)
    
    -- Release at nubbin position
    VirtualInputManager:SendMouseButtonEvent(nubbinScreenPos.X, nubbinScreenPos.Y, 0, false, game, 0)
    
    -- Restore DragDetector
    if dragDetector and originalMaxDistance then
        dragDetector.MaxActivationDistance = originalMaxDistance
    end
    
    wait(0.1)
end

-- Main execution
function Module5:Run()
    -- STEP 1: Filter Replacement Consumption
    if self:HasFilterReplacement() then
        self:EquipFilterReplacement()
        wait(0.5)
        
        while self:HasFilterReplacement() do
            self:LeftClick()
            wait(0.1)
        end
    end
    
    -- STEP 2: Check for nearby players - WAIT until clear
    while true do
        local nearbyPlayers = self:FindNearbyPlayers()
        
        if #nearbyPlayers == 0 then
            break -- No players, continue
        end
        
        -- Players detected, wait 1 second and check again
        wait(1)
    end
    
    -- STEP 3: Sliders (no players nearby)
    
    -- Teleport to starting position
    self.humanoidRootPart.CFrame = CFrame.new(-1210, -172, 746)
    wait(0.5)
    
    -- ENTER FREECAM ONCE (stays active for all sliders)
    local camera = workspace.CurrentCamera
    camera.CameraType = Enum.CameraType.Scriptable
    
    -- Slider 1: Nubbin1 - Check if WaitingSliderPart is NOT at specific position
    local pivot1 = Vector3.new(-1186.31262, -169.200333, 733.374756)
    local knobSlider1 = self:FindKnobSliderByPivot(pivot1)
    if knobSlider1 then
        local slidables1 = knobSlider1:FindFirstChild("Slidables")
        local shouldDoSlider1 = false
        
        if slidables1 then
            local waitingSliderPart1 = slidables1:FindFirstChild("WaitingSliderPart")
            if waitingSliderPart1 then
                local currentPos = waitingSliderPart1.Position
                local skipPos = Vector3.new(-1184.34631, -180.127106, 726.041992)
                local distance = (currentPos - skipPos).Magnitude
                
                if distance > 0.1 then
                    shouldDoSlider1 = true
                end
            end
        end
        
        if shouldDoSlider1 then
            self:DoSlider(knobSlider1, "Nubbin1", camera)
        end
    end
    
    -- Slider 2: Nubbin1 - Check if WaitingSliderPart is NOT at specific position
    local pivot2 = Vector3.new(-1186.31262, -179.600327, 733.374756)
    local knobSlider2 = self:FindKnobSliderByPivot(pivot2)
    if knobSlider2 then
        local slidables2 = knobSlider2:FindFirstChild("Slidables")
        local shouldDoSlider2 = false
        
        if slidables2 then
            local waitingSliderPart2 = slidables2:FindFirstChild("WaitingSliderPart")
            if waitingSliderPart2 then
                local currentPos = waitingSliderPart2.Position
                local skipPos = Vector3.new(-1184.34631, -180.12706, 731.84198)
                local distance = (currentPos - skipPos).Magnitude
                
                if distance > 0.1 then
                    shouldDoSlider2 = true
                end
            end
        end
        
        if shouldDoSlider2 then
            self:DoSlider(knobSlider2, "Nubbin1", camera)
        end
    end
    
    -- Slider 3: Nubbin10 - Check if WaitingSliderPart is NOT at specific position
    local pivot3 = Vector3.new(-1186.32153, -179.590424, 746.162292)
    local knobSlider3 = self:FindKnobSliderByPivot(pivot3)
    if knobSlider3 then
        local slidables3 = knobSlider3:FindFirstChild("Slidables")
        local shouldDoSlider3 = false
        
        if slidables3 then
            local waitingSliderPart3 = slidables3:FindFirstChild("WaitingSliderPart")
            if waitingSliderPart3 then
                local currentPos = waitingSliderPart3.Position
                local skipPos = Vector3.new(-1184.3553466796875, -180.11717224121094, 751.179443359375)
                local distance = (currentPos - skipPos).Magnitude
                
                if distance > 0.1 then
                    shouldDoSlider3 = true
                end
            end
        end
        
        if shouldDoSlider3 then
            self:DoSlider(knobSlider3, "Nubbin10", camera)
        end
    end
    
    -- Slider 4: NubbinOff - Check if WaitingSliderPart is NOT at specific position
    local pivot4 = Vector3.new(-1186.32153, -179.590424, 765.862244)
    local knobSlider4 = self:FindKnobSliderByPivot(pivot4)
    if knobSlider4 then
        local slidables4 = knobSlider4:FindFirstChild("Slidables")
        local shouldDoSlider4 = false
        
        if slidables4 then
            local waitingSliderPart4 = slidables4:FindFirstChild("WaitingSliderPart")
            if waitingSliderPart4 then
                local currentPos = waitingSliderPart4.Position
                local skipPos = Vector3.new(-1184.37305, -180.111938, 762.794556)
                local distance = (currentPos - skipPos).Magnitude
                
                if distance > 0.1 then
                    shouldDoSlider4 = true
                end
            end
        end
        
        if shouldDoSlider4 then
            self:DoSlider(knobSlider4, "NubbinOff", camera)
        end
    end
    
    -- RESTORE CAMERA ONCE (after all sliders done)
    camera.CameraType = Enum.CameraType.Custom
    
    -- STEP 4: Teleport and check for players again before coolant
    self.humanoidRootPart.CFrame = CFrame.new(-1248, -141, 49)
    wait(0.5)
    
    -- Wait until no players nearby
    while true do
        local nearbyPlayers = self:FindNearbyPlayers()
        
        if #nearbyPlayers == 0 then
            break -- No players, continue to coolant
        end
        
        -- Players detected, wait 1 second and check again
        wait(1)
    end
    
    -- STEP 5: Coolant Panels (no players nearby)
    
    -- Find all CoolantControlPanel models
    local coolantPanels = {}
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj.Name == "CoolantControlPanel" and (obj:IsA("Model") or obj:IsA("Folder")) then
            table.insert(coolantPanels, obj)
        end
    end
    
    -- Enter freecam
    camera.CameraType = Enum.CameraType.Scriptable
    
    -- Process each panel
    for i, panel in ipairs(coolantPanels) do
        -- Teleport to specific location for each panel
        if i == 1 then
            self.humanoidRootPart.CFrame = CFrame.new(-1240, -160, -37)
        elseif i == 2 then
            self.humanoidRootPart.CFrame = CFrame.new(-1214, -160, -38)
        end
        
        wait(0.3)
        
        -- Find CoolantControls
        local coolantControls = panel:FindFirstChild("CoolantControls")
        if not coolantControls then continue end
        
        -- Find StatusTitle
        local statusTitle = coolantControls:FindFirstChild("StatusTitle")
        if not statusTitle then continue end
        
        -- Find TextLabel
        local surfaceGui = statusTitle:FindFirstChild("SurfaceGui")
        if not surfaceGui then continue end
        
        local frame = surfaceGui:FindFirstChild("Frame")
        if not frame then continue end
        
        local textLabel = frame:FindFirstChild("TextLabel")
        if not textLabel then continue end
        
        -- Check TextLabel text
        if textLabel.Text ~= "ACTIVE" then continue end
        
        -- Find SpoolSwitch and ProximityPrompt
        local spoolSwitch = coolantControls:FindFirstChild("SpoolSwitch")
        if not spoolSwitch then continue end
        
        local proximityPrompt = spoolSwitch:FindFirstChildOfClass("ProximityPrompt", true)
        if not proximityPrompt then continue end
        
        -- Store and change MaxActivationDistance
        local originalDistance = proximityPrompt.MaxActivationDistance
        proximityPrompt.MaxActivationDistance = 1000
        
        -- Move camera and activate
        local promptPos = proximityPrompt.Parent.Position
        camera.CFrame = CFrame.new(promptPos + Vector3.new(0, 0, 5), promptPos)
        wait(0.2)
        
        -- Press F2
        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.F2, false, game)
        wait(0.1)
        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.F2, false, game)
        wait(0.3)
        
        -- Restore MaxActivationDistance
        proximityPrompt.MaxActivationDistance = originalDistance
    end
    
    -- Restore camera
    camera.CameraType = Enum.CameraType.Custom
    
    -- STEP 6: Resource Tool Consumption
    self.humanoidRootPart.CFrame = CFrame.new(-1107, -206, 724)
    wait(0.5)
    
    -- Keep using Resource tools until none left
    while self:HasResource() do
        self:EquipResource()
        wait(0.5)
        
        -- Hold E for 1 second
        self:HoldE()
        wait(0.5)
    end
    
    -- STEP 7: Load next module
    loadstring(game:HttpGet("https://raw.githubusercontent.com/gamedev1164/hhkalskjdfg/refs/heads/main/Reactor/Module%206", true))()
end

-- AUTO START
Module5:Init()
Module5:Run()
