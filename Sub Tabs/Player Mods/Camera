--==============================================================================
--                    AEGIS HUB - CAMERA MODULE (FIXED)
--==============================================================================

local AegisHub = _G.AegisHub
if not AegisHub or not AegisHub.CameraPage then 
    warn("Aegis Hub not loaded!") 
    return 
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local page = AegisHub.CameraPage
local Library = AegisHub.Library

-- State (from CoreX Camera Desync)
local State = {
    fovEnabled = false,
    fovValue = 70,
    
    freecamEnabled = false,
    freecamSpeed = 50,
    freecamCF = nil,
    freecamOrig = nil,
    freecamKeys = {W = false, A = false, S = false, D = false, Q = false, E = false, Shift = false},
    charOrig = nil,
    
    rmbDown = false,
    yaw = 0,
    pitch = 0,
    
    connections = {}
}

-- Helper functions
local function getChar() return player.Character end
local function getHumanoid() local c = getChar() return c and c:FindFirstChildOfClass("Humanoid") end
local function getHRP() local c = getChar() return c and c:FindFirstChild("HumanoidRootPart") end

-- FOV
local function enableFOV()
    local cam = Workspace.CurrentCamera
    if cam then 
        cam.FieldOfView = State.fovValue 
    end
end

local function disableFOV()
    local cam = Workspace.CurrentCamera
    if cam then 
        cam.FieldOfView = 70 
    end
end

-- FreeCam Key Handler
local function setCamKey(keyCode, isDown)
    if keyCode == Enum.KeyCode.W then State.freecamKeys.W = isDown
    elseif keyCode == Enum.KeyCode.A then State.freecamKeys.A = isDown
    elseif keyCode == Enum.KeyCode.S then State.freecamKeys.S = isDown
    elseif keyCode == Enum.KeyCode.D then State.freecamKeys.D = isDown
    elseif keyCode == Enum.KeyCode.Q then State.freecamKeys.Q = isDown
    elseif keyCode == Enum.KeyCode.E then State.freecamKeys.E = isDown
    elseif keyCode == Enum.KeyCode.LeftShift or keyCode == Enum.KeyCode.RightShift then
        State.freecamKeys.Shift = isDown
    end
end

-- Freeze Character
local function freezeCharacter(on)
    local hum = getHumanoid()
    local hrp = getHRP()
    if not hum or not hrp then return end
    
    if on then
        if not State.charOrig then
            State.charOrig = {
                PlatformStand = hum.PlatformStand,
                AutoRotate = hum.AutoRotate,
                Anchored = hrp.Anchored
            }
        end
        hum.AutoRotate = false
        hum.PlatformStand = true
        hrp.AssemblyLinearVelocity = Vector3.zero
        hrp.AssemblyAngularVelocity = Vector3.zero
        hrp.Anchored = true
    else
        local o = State.charOrig
        if o then
            hum.PlatformStand = o.PlatformStand
            hum.AutoRotate = o.AutoRotate
            hrp.Anchored = o.Anchored
        else
            hrp.Anchored = false
            hum.PlatformStand = false
            hum.AutoRotate = true
        end
        State.charOrig = nil
    end
end

-- Enable FreeCam (Camera Desync)
local function enableFreeCam()
    local cam = Workspace.CurrentCamera
    if not cam then return end
    
    if not State.freecamOrig then
        State.freecamOrig = {
            CameraType = cam.CameraType,
            CFrame = cam.CFrame,
            Subject = cam.CameraSubject
        }
    end
    
    State.freecamCF = cam.CFrame
    cam.CameraType = Enum.CameraType.Scriptable
    
    -- Calculate initial yaw/pitch from camera look vector
    local look = cam.CFrame.LookVector
    State.yaw = math.atan2(-look.X, -look.Z)
    State.pitch = math.asin(math.clamp(look.Y, -0.999, 0.999))
    
    freezeCharacter(true)
end

-- Disable FreeCam
local function disableFreeCam()
    local cam = Workspace.CurrentCamera
    if not cam then return end
    
    local o = State.freecamOrig
    if o then
        cam.CameraType = o.CameraType
        cam.CFrame = o.CFrame
        cam.CameraSubject = o.Subject
    else
        cam.CameraType = Enum.CameraType.Custom
    end
    
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    State.rmbDown = false
    State.freecamCF = nil
    State.freecamOrig = nil
    
    freezeCharacter(false)
end

-- Teleport to Camera
local function teleportToCam()
    local cam = Workspace.CurrentCamera
    local hrp = getHRP()
    
    if cam and hrp and State.freecamEnabled then
        hrp.CFrame = CFrame.new(cam.CFrame.Position)
        State.freecamEnabled = false
        disableFreeCam()
    end
end

-- Input Handlers
table.insert(State.connections, UserInputService.InputBegan:Connect(function(input, gpe)
    if not State.freecamEnabled then return end
    
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        State.rmbDown = true
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCurrentPosition
    elseif input.UserInputType == Enum.UserInputType.Keyboard and not gpe then
        setCamKey(input.KeyCode, true)
    end
end))

table.insert(State.connections, UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        State.rmbDown = false
        if State.freecamEnabled then
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        end
    elseif input.UserInputType == Enum.UserInputType.Keyboard then
        setCamKey(input.KeyCode, false)
    end
end))

-- Render Loop
table.insert(State.connections, RunService.RenderStepped:Connect(function(dt)
    if not State.freecamEnabled then return end
    
    local cam = Workspace.CurrentCamera
    if not cam then return end
    
    -- Ensure camera is scriptable
    if cam.CameraType ~= Enum.CameraType.Scriptable then
        enableFreeCam()
    end
    
    local cf = State.freecamCF or cam.CFrame
    
    -- Handle right-click rotation
    if State.rmbDown then
        local delta = UserInputService:GetMouseDelta()
        State.yaw = State.yaw - delta.X * 0.0035
        State.pitch = math.clamp(State.pitch - delta.Y * 0.0035, math.rad(-80), math.rad(80))
    end
    
    -- Build rotation matrix
    local rot = CFrame.fromOrientation(State.pitch, State.yaw, 0)
    local base = CFrame.new(cf.Position) * rot
    local look = base.LookVector
    local right = base.RightVector
    local up = Vector3.new(0, 1, 0)
    
    -- Calculate movement direction
    local x, y, z = 0, 0, 0
    if State.freecamKeys.D then x = x + 1 end
    if State.freecamKeys.A then x = x - 1 end
    if State.freecamKeys.S then z = z + 1 end
    if State.freecamKeys.W then z = z - 1 end
    if State.freecamKeys.E then y = y + 1 end
    if State.freecamKeys.Q then y = y - 1 end
    
    local dir = (right * x) + (look * (-z)) + (up * y)
    
    -- Apply movement
    if dir.Magnitude > 0 then
        local spd = State.freecamSpeed
        if State.freecamKeys.Shift then spd = spd * 2 end
        base = base + dir.Unit * (spd * dt)
    end
    
    State.freecamCF = base
    cam.CFrame = base
end))

-- Character respawn handler
table.insert(State.connections, player.CharacterAdded:Connect(function()
    task.wait(0.3)
    
    if State.fovEnabled then enableFOV() end
end))

-- Create UI
-- FOV with Toggle+Slider
Library:CreateToggleSlider(page, "FOV", 10, 120, 70, 
    function(enabled)
        State.fovEnabled = enabled
        if enabled then enableFOV() else disableFOV() end
    end,
    function(value)
        State.fovValue = value
        if State.fovEnabled then
            local cam = Workspace.CurrentCamera
            if cam then cam.FieldOfView = value end
        end
    end
)

-- FreeCam with integrated TP to Cam button
local freecamControl = Library:CreateFreeCamControl(page, "FreeCam", 1, 500, 50,
    function(enabled)
        State.freecamEnabled = enabled
        if enabled then enableFreeCam() else disableFreeCam() end
    end,
    function(value)
        State.freecamSpeed = value
    end,
    function()
        -- TP to Cam callback
        teleportToCam()
        -- Auto turn off toggle
        if freecamControl then
            freecamControl.setToggle(false)
        end
    end
)

print("âœ“ Camera Module Loaded")

return true
